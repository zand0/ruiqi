(function(y,D,ka){function xa(e){return ya.call(e)==="[object Function]"}function za(e){return ya.call(e)==="[object Array]"}function Da(e){return e&&ya.call(e)==="[object Object]"}function Aa(e){return(e||"").replace(/^\s+|\s+$/g,"")}function ta(e,h){var l=false;if(Da(h)){e=e||{};for(var m in h){var s=h[m];if(e[m]!=s){l=l||{};l[m]=s}}}return l}function la(e){var h=[];if(e!=null){var l=e.length;if(l==null||typeof e==="string"||xa(e)||e.setInterval)h[0]=e;else for(;l;)h[--l]=e[l]}return h}function H(){var e=
arguments[0]||{},h=1,l=arguments.length,m=false,s;if(typeof e==="boolean"){m=e;e=arguments[1]||{};h=2}if(typeof e!=="object"&&!xa(e))e={};for(;h<l;h++)if((s=arguments[h])!=null)for(var t in s){var p=e[t],K=s[t];if(e!==K)if(m&&K&&typeof K==="object"&&!K.nodeType)e[t]=H(m,p||(K.length!=null?[]:{}),K);else if(K!==ka)e[t]=K}return e}function O(e,h,l){var m,s=0,t=e.length,p=t===ka||xa(e);if(l)if(p)for(m in e){if(h.apply(e[m],l)===false)break}else for(;s<t;){if(h.apply(e[s++],l)===false)break}else if(p)for(m in e){if(h.call(e[m],
m,e[m])===false)break}else for(l=e[0];s<t&&h.call(l,s,l)!==false;l=e[++s]);return e}function fa(e,h,l){for(var m=[],s=0,t=e.length;s<t;s++)!l!==!h(e[s],s)&&m.push(e[s]);return m}function ua(e,h){for(var l=[],m,s=0,t=e.length;s<t;s++){m=h(e[s],s);if(m!=null)l[l.length]=m}return l.concat.apply([],l)}function ga(e){this.type=e;this.timeStamp=(new Date).getTime()}function M(e){this.URL=e;this._setting();this._connect()}function C(e,h){var l=this;h=h||{};var m=l.ws=new WebSocket(e);m.onopen=function(){l.trigger("open",
"success");m.send("subscribe "+h.domain+" "+h.ticket)};m.onclose=function(s){l.trigger("close",[s.data])};m.onmessage=function(s){s=s.data;try{s=s?y.JSON&&y.JSON.parse?y.JSON.parse(s):(new Function("return "+s))():s}catch(t){}l.trigger("message",[s])};m.onerror=function(){l.trigger("error",[])}}function oa(e,h,l){if(typeof h!="undefined"){l=l||{};if(h===null){h="";l.expires=-1}var m="";if(l.expires&&(typeof l.expires=="number"||l.expires.toUTCString)){if(typeof l.expires=="number"){m=new Date;m.setTime(m.getTime()+
l.expires*24*60*60*1E3)}else m=l.expires;m="; expires="+m.toUTCString()}var s=l.path?"; path="+l.path:"",t=l.domain?"; domain="+l.domain:"";l=l.secure?"; secure":"";D.cookie=[e,"=",encodeURIComponent(h),m,s,t,l].join("")}else{h=null;if(D.cookie&&D.cookie!=""){l=D.cookie.split(";");for(m=0;m<l.length;m++){s=Aa(l[m]);if(s.substring(0,e.length+1)==e+"="){h=decodeURIComponent(s.substring(e.length+1));break}}}return h}}function J(e,h){this.options=H({},J.defaults,h);this._init(e,h)}function z(e){return e&&
e.split?e.split(","):za(e)?e:parseInt(e)?[parseInt(e)]:[]}function ja(e,h,l){function m(s,t){this.data=s;this.options=H({},m.defaults,t);xa(this._init)&&this._init()}m.defaults=h;ga.on(m);H(m.prototype,l);J[e]=m}function F(e,h){if(typeof e=="string"){e[e]=h;if(h===ka)return F[e]}H(F,e)}var ya=Object.prototype.toString;ga.on=function(){for(var e,h=ga.on.prototype,l=0,m=arguments.length;l<m;l++){e=arguments[l].prototype;e.bind=e.addEventListener=h.addEventListener;e.unbind=e.removeEventListener=h.removeEventListener;
e.trigger=e.dispatchEvent=h.dispatchEvent}};ga.on.prototype={addEventListener:function(e,h){var l=this.__listeners=this.__listeners||{};l[e]=l[e]||[];l[e].push(h);return this},dispatchEvent:function(e,h){var l=this.__listeners=this.__listeners||{};e=e.type?e:new ga(e);l=l[e.type];if(Object.prototype.toString.call(h)==="[object Array]")h.unshift(e);else h=[e,h];if(l)for(var m=0,s=l.length;m<s;m++)l[m].apply(this,h);return this},removeEventListener:function(e,h){var l=this.__listeners=this.__listeners||
{};if(l[e])if(h){l=l[e];for(var m=l.length;m--;)l[m]===h&&l.splice(m,1)}else delete l[e];return this}};var U=function(){function e(v){var o={};for(var L in e.settings)o[L]=e.settings[L];if(v)for(L in v)o[L]=v[L];if(o.dataType==="jsonp")o.type="GET";var S,W,ba,ma=o.type.toUpperCase(),pa=s.test(ma),G,A,ha=y,Y;o.url=o.url.replace(R,"");o.context=v&&v.context!=null?v.context:o;if(o.data&&o.processData&&typeof o.data!=="string")o.data=h(o.data,o.traditional);var ia=B.exec(o.url);L=y.location;ia=ia&&(ia[1]&&
ia[1]!==L.protocol||ia[2]!==L.host);/https?:/i.test(L.protocol)||(ia=false);ia=o.forceRemote?true:ia;if(o.dataType==="jsonp"&&!ia)o.dataType="json";if(o.dataType==="jsonp"){if(ma==="GET")p.test(o.url)||(o.url+=(K.test(o.url)?"&":"?")+(o.jsonp||"callback")+"=?");else if(!o.data||!p.test(o.data))o.data=(o.data?o.data+"&":"")+(o.jsonp||"callback")+"=?";o.dataType="json"}if(o.dataType==="json"&&(o.data&&p.test(o.data)||p.test(o.url))){S=o.jsonpCallback||"jsonp"+l++;if(o.data)o.data=(o.data+"").replace(p,
"="+S+"$1");o.url=o.url.replace(p,"="+S+"$1");o.dataType="script";var Ha=y[S],na=false;y[S]=function(T){if(!na){na=true;if(Object.prototype.toString.call(Ha)==="[object Function]")Ha(T);else{y[S]=ka;try{delete y[S]}catch(Ea){}}ba=T;P.handleSuccess(o,E,W,ba);P.handleComplete(o,E,W,ba);G&&G.removeChild(Y);A&&A.parentNode&&A.parentNode.removeChild(A)}}}if(o.dataType==="script"&&o.cache===null)o.cache=false;if(o.cache===false&&ma==="GET"){var va=(new Date).getTime(),Ba=o.url.replace(I,"$1_="+va);o.url=
Ba+(Ba===o.url?(K.test(o.url)?"&":"?")+"_="+va:"")}if(o.data&&ma==="GET")o.url+=(K.test(o.url)?"&":"?")+o.data;o.global&&P.active++;if(o.dataType==="script"&&ma==="GET"&&ia){v=false;if(S&&o.async&&!m)if(y._fragmentProxy)G=A=D.createDocumentFragment();else{v=true;if(o.url.slice(0,1)=="/")o.url=L.protocol+"//"+L.host+(L.port?":"+L.port:"")+o.url;else if(!/^https?:\/\//i.test(o.url)){L=L.href;ma=/([^?#]+)\//.exec(L);o.url=(ma?ma[1]:L)+"/"+o.url}o.url=o.url.replace("="+S,"=parent."+S);A=D.createElement("iframe");
A.style.position="absolute";A.style.left="-100px";A.style.top="-100px";A.style.height="1px";A.style.width="1px";A.style.visibility="hidden";D.body.insertBefore(A,D.body.firstChild);ha=A.contentWindow}var Ca=function(){var T;try{T=ha.document}catch(Ea){T=y.document}G=G||T.getElementsByTagName("head")[0]||T.documentElement;Y=T.createElement("script");if(o.scriptCharset)Y.charset=o.scriptCharset;Y.src=o.url;if(m)Y.async=o.async;if(S)Y.onload=Y.onerror=Y.onreadystatechange=function(){if(!na&&(!this.readyState||
this.readyState==="loaded"||this.readyState==="complete")){na=true;P.handleError(o,E,"error","load error");G&&Y.parentNode&&G.removeChild(Y);A&&A.parentNode&&A.parentNode.removeChild(A)}};else{var Fa=false;Y.onload=Y.onreadystatechange=function(){if(!Fa&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){Fa=true;P.handleSuccess(o,E,W,ba);P.handleComplete(o,E,W,ba);Y.onload=Y.onreadystatechange=null;G&&Y.parentNode&&G.removeChild(Y)}}}G.insertBefore(Y,G.firstChild)};v?setTimeout(function(){Ca()},
0):Ca();return ka}var wa=false,E=o.xhr();if(E){o.username?E.open(ma,o.url,o.async,o.username,o.password):E.open(ma,o.url,o.async);try{if(o.data!=null&&!pa||v&&v.contentType)E.setRequestHeader("Content-Type",o.contentType);if(o.ifModified){P.lastModified[o.url]&&E.setRequestHeader("If-Modified-Since",P.lastModified[o.url]);P.etag[o.url]&&E.setRequestHeader("If-None-Match",P.etag[o.url])}ia||E.setRequestHeader("X-Requested-With","XMLHttpRequest");E.setRequestHeader("Accept",o.dataType&&o.accepts[o.dataType]?
o.accepts[o.dataType]+", */*; q=0.01":o.accepts._default)}catch(Ja){}if(o.beforeSend&&o.beforeSend.call(o.context,E,o)===false){o.global&&P.active--;E.abort();return false}o.global&&P.triggerGlobal(o,"ajaxSend",[E,o]);var Ga=E.onreadystatechange=function(T){if(!E||E.readyState===0||T==="abort"){wa||P.handleComplete(o,E,W,ba);wa=true;if(E)E.onreadystatechange=P.noop}else if(!wa&&E&&(E.readyState===4||T==="timeout")){wa=true;E.onreadystatechange=P.noop;W=T==="timeout"?"timeout":!P.httpSuccess(E)?"error":
o.ifModified&&P.httpNotModified(E,o.url)?"notmodified":"success";var Ea;if(W==="success")try{ba=P.httpData(E,o.dataType,o)}catch(Fa){W="parsererror";Ea=Fa}if(W==="success"||W==="notmodified")S||P.handleSuccess(o,E,W,ba);else P.handleError(o,E,W,Ea);S||P.handleComplete(o,E,W,ba);T==="timeout"&&E.abort();if(o.async)E=null}};try{var Ia=E.abort;E.abort=function(){E&&Ia.call&&Ia.call(E);Ga("abort")}}catch(qa){}o.async&&o.timeout>0&&setTimeout(function(){E&&!wa&&Ga("timeout")},o.timeout);try{E.send(pa||
o.data==null?null:o.data)}catch(X){P.handleError(o,E,null,X);P.handleComplete(o,E,W,ba)}o.async||Ga();return E}}function h(v){var o=[];if(typeof v=="object"){for(var L in v)o[o.length]=encodeURIComponent(L)+"="+encodeURIComponent(v[L]);return o.join("&").replace(ca,"+")}return v}var l=(new Date).getTime(),m=typeof D.createElement("script").async==="boolean",s=/^(?:GET|HEAD|DELETE)$/,t=/\S/,p=/\=\?(&|$)/,K=/\?/,I=/([?&])_=[^&]*/,B=/^(\w+:)?\/\/([^\/?#]+)/,ca=/%20/g,R=/#.*$/;y._fragmentProxy=false;
var V=D.createDocumentFragment(),Q=D.createElement("script");try{Q.appendChild(D.createTextNode("window._fragmentProxy = true"))}catch(ea){Q.text="window._fragmentProxy = true"}V.appendChild(Q);V=Q=null;e.param=h;var P={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(v,o,L,S){v.error&&v.error.call(v.context,o,L,S);v.global&&P.triggerGlobal(v,"ajaxError",[o,v,S])},handleSuccess:function(v,o,L,S){v.success&&v.success.call(v.context,S,L,o);v.global&&P.triggerGlobal(v,"ajaxSuccess",
[o,v])},handleComplete:function(v,o,L){v.complete&&v.complete.call(v.context,o,L);v.global&&P.triggerGlobal(v,"ajaxComplete",[o,v]);v.global&&P.active--},triggerGlobal:function(){},httpSuccess:function(v){try{return!v.status&&location.protocol==="file:"||v.status>=200&&v.status<300||v.status===304||v.status===1223}catch(o){}return false},httpNotModified:function(v,o){var L=v.getResponseHeader("Last-Modified"),S=v.getResponseHeader("Etag");if(L)P.lastModified[o]=L;if(S)P.etag[o]=S;return v.status===
304},httpData:function(v,o,L){var S=v.getResponseHeader("content-type")||"",W=o==="xml"||!o&&S.indexOf("xml")>=0;v=W?v.responseXML:v.responseText;W&&v.documentElement.nodeName==="parsererror"&&P.error("parsererror");if(L&&L.dataFilter)v=L.dataFilter(v,o);if(typeof v==="string")if(o==="json"||!o&&S.indexOf("json")>=0)v=v?y.JSON&&y.JSON.parse?y.JSON.parse(v):(new Function("return "+v))():v;else if(o==="script"||!o&&S.indexOf("javascript")>=0)if(v&&t.test(v)){o=D.getElementsByTagName("head")[0]||D.documentElement;
L=D.createElement("script");L.type="text/javascript";try{L.appendChild(D.createTextNode(v))}catch(ba){L.text=v}o.insertBefore(L,o.firstChild);o.removeChild(L)}return v}};e.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new y.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",
_default:"*/*"}};e.setup=function(v){if(v)for(var o in v)e.settings[o]=v[o]};if(y.ActiveXObject)e.settings.xhr=function(){if(y.location.protocol!=="file:")try{return new y.XMLHttpRequest}catch(v){}try{return new y.ActiveXObject("Microsoft.XMLHTTP")}catch(o){}};return e}(),ra=y.JSON?y.JSON:function(){function e(m){return l[m]||"\\u00"+Math.floor(m.charCodeAt()/16).toString(16)+(m.charCodeAt()%16).toString(16)}function h(m){switch(Object.prototype.toString.call(m)){case "[object String]":return'"'+
m.replace(/[\x00-\x1f\\"]/g,e)+'"';case "[object Array]":for(var s=[],t=m.length,p=0;p<t;p++)s.push(h(m[p]));return"["+s.join(",")+"]";case "[object Object]":s=[];for(t in m)(p=h(m[t]))&&s.push(h(t)+":"+p);return"{"+s+"}";case "[object Number]":case "[object Boolean]":return String(m);case false:return"null"}return null}var l={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:h,parse:function(m){m=m.toString();if(!m||!m.length)return null;return(new Function("return "+
m))()}}}();M.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=M.CLOSED;this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var e=this;if(e._connecting)return e;e.readyState=M.CONNECTING;e._connecting=true;e._onPolling||y.setTimeout(function(){e._startPolling()},300);return e},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=
M.OPEN;this.trigger("open","success")},_onClose:function(e){var h=this;h._setting();setTimeout(function(){h.trigger("close",[e])},1E3)},_onData:function(e){this.trigger("message",[e])},_onError:function(e){var h=this;h._setting();setTimeout(function(){h.trigger("error",[e])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;U({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(e){var h=
this;h._onPolling=false;if(h._connecting)if(e){h._pollingTimes==1&&h._onConnect();h._onData(e);h._failTimes=0;h._pollTimer=y.setTimeout(function(){h._startPolling()},200)}else return h._onError("error data")},_onPollError:function(e){var h=this;h._onPolling=false;if(h._connecting){h._failTimes++;if(h._pollingTimes==1)h._onError("can not connect.");else if(h._failTimes>1)h._onClose(e);else h._pollTimer=y.setTimeout(function(){h._startPolling()},200)}}};M.CONNECTING=0;M.OPEN=1;M.CLOSED=2;ga.on(M);C.prototype=
{readyState:0,send:function(){},close:function(){this.ws.close()}};C.enable=!!y.WebSocket;C.CONNECTING=0;C.OPEN=1;C.CLOSED=2;ga.on(C);ga.on(J);J.csrf_token="";J.OFFLINE=0;J.BEFOREONLINE=1;J.ONLINE=2;H(J.prototype,{state:J.OFFLINE,_init:function(){var e=this.options;this.data={user:{presence:"offline",show:"unavailable"}};this.models={};U.settings.dataType=e.jsonp?"jsonp":"json";this.status=new J.status(null,e);this.setting=new J.setting;this.models.presence=new J.presence;this.buddy=new J.buddy;this.room=
new J.room(null,this.data);this.history=new J.history(null,this.data);this._initEvents()},_createConnect:function(){var e=this,h=e.data.connection;e.connection=e.options.connectionType!="jsonpd"&&h.websocket&&C.enable?new C(h.websocket,h):new M(h.server+(/\?/.test(h)?"&":"?")+U.param({ticket:h.ticket,domain:h.domain}));e.connection.bind("connect",function(){}).bind("message",function(l,m){e.handle(m)}).bind("error",function(){e._stop("connect","Connect Error")}).bind("close",function(){e._stop("connect",
"Disconnect")})},setUser:function(e){H(this.data.user,e)},_ready:function(e){this.state=J.BEFOREONLINE;this.trigger("beforeOnline",[e])},_go:function(){var e=this.data,h=this.history,l=this.buddy,m=this.room,s=this.models.presence;this.state=J.ONLINE;h.options.userInfo=e.user;O(e.buddies,function(t,p){h.init("chat",p.id,p.history)});l.set(e.buddies);e.presences?s.set(e.presences):s.set(ua(e.buddies,function(t){var p={};p[t.id]=t.show;return p}));O(e.rooms,function(t,p){h.init("grpchat",p.id,p.history)});
m.set(e.rooms);m.options.ticket=e.connection.ticket;this.trigger("online",[e]);this._createConnect();l=[];if(e.new_messages)l=l.concat(e.new_messages);if(e.offline_messages)l=l.concat(e.offline_messages);if(l&&l.length){O(l,function(t,p){p["new"]=true});this.trigger("message",[l])}},_stop:function(e,h){if(this.state!==J.OFFLINE){this.state=J.OFFLINE;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.models.presence.clear();this.room.clear();this.history.clean();
this.trigger("offline",[e,h])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function e(I){var B={id:I.from,presence:I.type};if(I.show)B.show=I.show;if(I.nick)B.nick=I.nick;if(I.status)B.status=I.status;return B}function h(I){return I.type=="online"||I.type=="offline"||I.type=="show"}function l(I){return I.type=="grponline"||I.type=="grpoffline"||I.type=="invite"||I.type=="join"||I.type=="leave"}var m=this,s=m.history,t=m.buddy,p=m.models.presence,K=m.room;m.bind("message",
function(I,B){for(var ca=[],R=B.length,V=m.data.user.id,Q,ea,P,v=0;v<R;v++){Q=B[v];P=Q.type;ea=P=="chat"?Q.to==V?Q.from:Q.to:Q.to;Q.id=ea;if(P=="chat"&&!Q["new"]){ea={id:ea,presence:"online"};if(Q.nick&&Q.to==V)ea.nick=Q.nick;ca.push(ea)}}if(ca.length){t.presence(ca);t.complete()}s.set(B)});m.bind("presence",function(I,B){var ca=fa(B,h);t.presence(ua(ca,e));p.update(ca);B=fa(B,l);for(ca=B.length-1;ca>=0;ca--)K.onPresence(B[ca])})},handle:function(e){if(e.messages&&e.messages.length){for(var h=e.messages,
l=[],m=[],s=0;s<h.length;s++){var t=h[s];if(t.body&&t.body.indexOf("webim-event:")==0){t.event=t.body.replace("webim-event:","").split("|,|");m.push(t)}else l.push(t)}l.length&&this.trigger("message",[l]);m.length&&this.trigger("event",[m])}e.presences&&e.presences.length&&this.trigger("presence",[e.presences]);e.statuses&&e.statuses.length&&this.trigger("status",[e.statuses])},sendMessage:function(e,h){e.ticket=this.data.connection.ticket;this.trigger("sendMessage",[e]);U({type:"post",cache:false,
url:F("message"),data:H({csrf_token:J.csrf_token},e),success:h,error:h})},sendStatus:function(e,h){e.ticket=this.data.connection.ticket;this.trigger("sendStatus",[e]);U({type:"post",cache:false,url:F("status"),data:H({csrf_token:J.csrf_token},e),success:h,error:h})},sendPresence:function(e,h){e.ticket=this.data.connection.ticket;this.data.user.show=e.show;this.status.set("s",e.show);this.trigger("sendPresence",[e]);U({type:"post",cache:false,url:F("presence"),data:H({csrf_token:J.csrf_token},e),success:h,
error:h})},online:function(e){var h=this,l=h.status;if(h.state===J.OFFLINE){var m=[],s=[],t=l.get("tabs"),p=l.get("tabIds");p&&p.length&&t&&O(t,function(K){K[0]=="b"&&m.push(K.slice(2));K[0]=="r"&&s.push(K.slice(2))});e=H({buddy_ids:m.join(","),room_ids:s.join(","),csrf_token:J.csrf_token,show:l.get("s")||"available"},e);h._ready(e);l.set("o",false);l.set("s",e.show);U({type:"post",cache:false,url:F("online"),data:e,success:function(K){if(K)if(K.success){K.user=H(h.data.user,K.user,{presence:"online"});
h.data=K;h._go()}else h._stop("online",K.error_msg);else h._stop("online","Not Found")},error:function(){h._stop("online","Not Found")}})}},offline:function(){var e=this.data;if(this.state!==J.OFFLINE){this.status.set("o",true);this.connection.close();this._stop("offline","offline");U({type:"post",cache:false,url:F("offline"),data:{status:"offline",csrf_token:J.csrf_token,ticket:e.connection.ticket}})}},_deactivate:function(){var e=this.data;!e||!e.connection||!e.connection.ticket||U({type:"get",
cache:false,url:F("deactivate"),data:{ticket:e.connection.ticket,csrf_token:J.csrf_token}})}});y.webim=J;H(J,{version:"5.5",defaults:{},log:function(){var e=new Date;["[",e.getHours(),":",e.getMinutes(),":",e.getSeconds(),"-",e.getMilliseconds(),"]"].join("");if(y&&y.console)y.console.log.apply(null,arguments);else y&&y.runtime&&y.air&&y.air.Introspector&&y.air.Introspector.Console.log.apply(null,arguments)},idsArray:z,now:function(){return(new Date).getTime()},isFunction:xa,isArray:za,isObject:Da,
trim:Aa,makeArray:la,extend:H,each:O,inArray:function(e,h){for(var l=0,m=h.length;l<m;l++)if(h[l]===e)return l;return-1},grep:fa,map:ua,JSON:ra,ajax:U,comet:M,socket:C,model:ja,route:F,ClassEvent:ga,isMobile:function(){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(navigator.userAgent||
navigator.vendor||y.opera)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test((navigator.userAgent||
navigator.vendor||y.opera).substr(0,4))}});ja("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){this.data=H({},this.options.data,this.data)},get:function(e){return this.data[e]},set:function(e,h){var l=this,m=e;if(e){if(typeof e=="string"){m={};m[e]=h}var s=l.data,t=ta(s,m);if(t){O(t,function(p,K){l.trigger("update",[p,K])});m=H({},s,m);l.data=m;U({type:"post",url:F("setting"),cache:false,data:{data:ra.stringify(m),csrf_token:J.csrf_token}})}}}});
ja("status",{key:"_webim",storage:"local",domain:D.domain},{_init:function(){var e=this.data,h=this.options.key,l=this.options.storage=="local"&&y.localStorage;if(l)try{l.setItem("__store_webim__","__store_webim__");if(l.getItem("__store_webim__")=="__store_webim__")this.store=l;l.removeItem("__store_webim__")}catch(m){this.store=ka}if(e)this._save(e);else this.data=(e=this.store?this.store.getItem(h):oa(h))?ra.parse(e):{}},set:function(e,h){var l=e;if(typeof e=="string"){l={};l[e]=h}var m=this.data;
ta(m,l)&&this._save(H({},m,l))},get:function(e){return this.data[e]},clear:function(){this._save({})},_save:function(e){var h=this.options.key,l=this.options.domain;this.data=e;e=ra.stringify(e);this.store?this.store.setItem(h,e):oa(h,e,{path:"/",domain:l})}});ja("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},remove:function(e){var h=this.get(e);if(h){U({type:"post",url:F("remove_buddy"),cache:false,data:{id:e,csrf_token:J.csrf_token},success:function(){}});
this.trigger("unsubscribe",[[h]]);delete this.dataHash[e]}},clear:function(){this.data=[];this.dataHash={}},count:function(e){var h=this.dataHash,l=0,m;for(var s in h)if(Da(e)){m=true;for(var t in e)if(e[t]!=h[s][t])m=false;m&&l++}else l++;return l},get:function(e){return this.dataHash[e]},all:function(e){return e?fa(this.data,function(h){return h.show!="invisible"&&h.presence=="online"}):this.data},complete:function(){var e=this.dataHash,h=[],l;for(var m in e){l=e[m];if(l.incomplete){l.incomplete=
false;h.push(m)}}this.load(h)},update:function(e){this.load(e)},presence:function(e){var h=this.dataHash;e=za(e)?e:[e];for(var l in e){var m=e[l];m.presence=m.presence=="offline"?"offline":"online";m.incomplete=!h[m.id];if(!m.group&&m.id)m.group=m.id.indexOf("vid:")==0?"visitor":m.group}this.set(e)},load:function(e){e=z(e);e.length&&U({type:"get",url:F("buddies"),cache:false,data:{ids:e.join(","),csrf_token:J.csrf_token},context:this,success:this.set})},search:function(e,h){var l=this;U({type:"post",
url:F("search"),cache:false,data:{nick:e,csrf_token:J.csrf_token},context:l,success:function(m){l.set(m);setTimeout(h,500)}})},set:function(e){var h=this.data,l=this.dataHash,m={};e=e||[];for(var s=e.length,t,p,K,I=0;I<s;I++){t=e[I];if(K=t.id){if(!l[K]){t.presence=t.presence||"online";t.show=t.show?t.show:t.presence=="offline"?"unavailable":"available";l[K]={};h.push(l[K])}t.incomplete=!!t.incomplete;if(p=ta(l[K],t)){t=p.presence||"update";m[t]=m[t]||[];H(l[K],p);m[t].push(l[K])}}}for(var B in m)this.trigger(B,
[m[B]]);this.options.active&&this.complete()}});ja("presence",{},{_init:function(){this.data=this.data||{};this.set(this.data)},get:function(e){return this.data[e]},set:function(e){var h={};for(var l in e){var m=e[l],s="online";if(m=="unavailable"||m=="invisible")s="offline";h[s]=h[s]||[];h[s].push({id:l,show:m})}for(var t in h)this.trigger(t,[h[t]])},update:function(e){for(var h={},l=0;l<e.length;l++){var m=e[l];h[m.from]=m.show}this.set(h)},clear:function(){this.data=[]}});(function(){ja("room",
{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(e){return this.dataHash[e]},all:function(e){return e?fa(this.data,function(h){return h.temporary}):this.data},invite:function(e,h,l,m){var s=this,t=s.options;U({type:"post",cache:false,url:F("invite"),data:{ticket:t.ticket,id:e,nick:h||"",members:l.join(","),csrf_token:J.csrf_token},success:function(p){s.set([p]);s.loadMember(e);m&&m(p)}})},join:function(e,h,l){var m=this,s=m.options;U({type:"post",cache:false,url:F("join"),
data:{ticket:s.ticket,id:e,nick:h||"",csrf_token:J.csrf_token},success:function(t){m.set([t]);m.loadMember(e);l&&l(t)}})},leave:function(e){var h=this,l=h.options,m=h.dataHash[e],s=l.user;m&&U({type:"post",cache:false,url:F("leave"),data:{ticket:l.ticket,id:e,nick:s.nick,temporary:m.temporary,csrf_token:J.csrf_token},success:function(){delete h.dataHash[e];h.trigger("leaved",[e])}})},block:function(e){var h=this,l=h.options,m=h.dataHash[e];if(m&&!m.blocked){m.blocked=true;var s=[];O(h.dataHash,function(t,
p){!p.temporary&&p.blocked&&s.push(p.id)});U({type:"post",cache:false,url:F("block"),data:{ticket:l.ticket,id:e,csrf_token:J.csrf_token},success:function(){h.trigger("blocked",[e,s])}})}},unblock:function(e){var h=this,l=h.options,m=h.dataHash[e];if(m&&m.blocked){m.blocked=false;var s=[];O(h.dataHash,function(t,p){!p.temporary&&p.blocked&&s.push(p.id)});U({type:"post",cache:false,url:F("unblock"),data:{ticket:l.ticket,id:e,csrf_token:J.csrf_token},success:function(){h.trigger("unblocked",[e,s])}})}},
set:function(e){var h=this,l=h.data,m=h.dataHash;O(e,function(s,t){var p=t.id;if(p){t.members=t.members||[];t.all_count=t.members.length;t.count=0;O(t.members,function(K,I){if(I.presence=="online")t.count+=1});if(m[p])H(m[p],t);else{m[p]=t;l.push(t)}h.trigger("updated",m[p])}})},loadMember:function(e){var h=this,l=h.options;U({type:"get",cache:false,url:F("members"),data:{ticket:l.ticket,id:e,csrf_token:J.csrf_token},success:function(m){h.updateMember(e,m)}})},updateMember:function(e,h){var l=this.dataHash[e];
if(l){l.memberLoaded=true;l.members=h;this.set([l])}},onPresence:function(e){var h=e.type;if(e.to&&this.dataHash[e.to]){var l=e.to,m=this.dataHash[l];m&&m.memberLoaded&&this.loadMember(l);if(h=="join")this.trigger("memberJoined",[l,e]);else if(h=="leave")this.trigger("memberLeaved",[l,e]);else if(h=="grponline")this.trigger("memberOnline",[l,e]);else h=="grpoffline"&&this.trigger("memberOffline",[l,e])}},clear:function(){this.data=[];this.dataHash={}}})})();ja("history",{},{_init:function(){this.data=
this.data||{};this.data.chat=this.data.chat||{};this.data.grpchat=this.data.grpchat||{}},clean:function(){this.data.chat={};this.data.grpchat={}},get:function(e,h){return this.data[e][h]},set:function(e){var h=this.data,l={chat:{},grpchat:{}};e=la(e);var m=e.length,s,t,p=this.options.userInfo.id;if(m){for(var K=0;K<m;K++){s=e[K];I=s.type;if((t=I=="chat"?s.to==p?s.from:s.to:s.to)&&I){l[I][t]=l[I][t]||[];l[I][t].push(s)}}for(var I in l)for(t in l[I]){s=l[I][t];if(h[I][t]){h[I][t]=[].concat(h[I][t]).concat(s);
this._triggerMsg(I,t,s)}else this.load(I,t)}}},_triggerMsg:function(e,h,l){this.trigger(e,[h,l])},clear:function(e,h){this.data[e][h]=[];this.trigger("clear",[e,h]);U({url:F("clear"),type:"post",cache:false,data:{type:e,id:h,csrf_token:J.csrf_token}})},download:function(e,h){var l=F("download"),m=D.createElement("iframe"),s=new Date,t=[];s={id:h,type:e,time:(new Date).getTime(),date:s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()};for(var p in s)t[t.length]=encodeURIComponent(p)+"="+encodeURIComponent(s[p]);
l+=(/\?/.test(l)?"&":"?")+t.join("&");m.setAttribute("src",l);m.style.display="none";D.body.appendChild(m)},init:function(e,h,l){if(za(l)){this.data[e][h]=l;this._triggerMsg(e,h,l)}},load:function(e,h){var l=this;l.data[e][h]=[];U({url:F("history"),cache:false,type:"get",data:{type:e,id:h,csrf_token:J.csrf_token},success:function(m){l.init(e,h,m)}})}})})(window,document);
(function(y,D,ka){function xa(){return false}function za(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&amp;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Da(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function Aa(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function ta(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&c.push(a);return c}function la(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function H(a,b){if(a)la(a,b)||(a.className+=" "+b)}function O(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function fa(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function ua(a,b,c){z(a,"mouseover",function(){H(this,b);c&&O(this,c)});z(a,"mouseout",function(){O(this,
b);c&&H(this,c)})}function ga(a,b,c){if(typeof c==="boolean")c?H(a,b):O(a,b);else la(a,b)?O(a,b):H(a,b)}function M(a){a&&a.style&&(a.style.display="block")}function C(a){a&&a.style&&(a.style.display="none")}function oa(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function J(a,b){var c=a.childNodes;for(i=0;i<c.length;i++)a.removeChild(c[i]);typeof b==="string"?a.innerHTML=b:a.appendChild(b)}function z(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+
b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function ja(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}}function F(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function ya(a){if(!a.target)a.target=a.srcElement||D;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function U(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";a.style.OUserSelect="none";a.style.WebkitUserSelect="none";z(a,"selectstart",xa)}function ra(){if(!Ba){Ba=
true;if(Ca){for(var a,b=0;a=Ca[b++];)a();Ca=null}}}function e(){if(!wa){wa=true;if(D.readyState==="complete")return ra();if(D.addEventListener)D.addEventListener("DOMContentLoaded",function(){D.removeEventListener("DOMContentLoaded",arguments.callee,false);ra()},false);else if(D.attachEvent){D.attachEvent("onreadystatechange",function(){if(D.readyState==="complete"){D.detachEvent("onreadystatechange",arguments.callee);ra()}});D.documentElement.doScroll&&y==y.top&&function(){if(!Ba){try{D.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,
0);return}ra()}}()}z(y,"load",ra)}}function h(a){var b=new Date;b.setTime(a?parseFloat(a)+h.timeSkew:(new Date).getTime());this.date=b}function l(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function m(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function s(a){return a?y.JSON&&y.JSON.parse?y.JSON.parse(a):(new Function("return "+a))():a}function t(a,b,c){l(a,"submit",function(){function d(){try{var n=
g.contentWindow.name||null;if(n!=null){m(f);b&&b(s(n))}else throw Error("Empty data");}catch(u){m(f);b&&b({error:"Retrieve data error"})}}c&&c();a.setAttribute("target","_upload_form13123");var f=D.createElement("div");f.innerHTML='<iframe name="_upload_form13123" id="_upload_form13123" style="display:none;" scrolling="no" frameborder="0"></iframe>';var g=f.firstChild;D.body.appendChild(f);if(y.postMessage){var k=function(n){var u=y,q=k;if(u.addEventListener)u.removeEventListener("message",q,false);
else{u.detachEvent("onmessage",u["message"+q]);u["message"+q]=null}m(f);b&&b(s(n.data))};l(y,"message",k)}else{var j=false;l(g,"load",function(){if(j)y.attachEvent||d();else{j=true;g.contentWindow.location="about:blank"}});if(y.attachEvent)g.onreadystatechange=function(){j&&d()}}})}function p(a,b,c){c=G({locale:p.locale},c);c=p.dictionary[c.locale];ba(c)||(c={});a=c[a]===ka?a:c[a];if(b){Ga=b;for(var d in b)a=a.replace(/\{\{(.*?)\}\}/g,Ia)}return a}function K(){var a=y,b=D,c=b.documentElement;b=b.getElementsByTagName("body")[0];
return{x:a.innerWidth||c.clientWidth||b.clientWidth,y:a.innerHeight||c.clientHeight||b.clientHeight}}function I(a,b,c){b=b||600;c=c||400;y.open(a,"_blank","height="+b+",width="+c+",fullscreen=3,top=40,left=40,status=no,toolbar=no,menubar=no,resizable=no,scrollbars=no,location=no,titlebar=no,fullscreen=no")}function B(a,b){this.element=a;this.options=G({},B.defaults,b);this._init()}function ca(a){a=a.getElementsByTagName("*");for(var b,c,d={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==
0)d[c.substring(1,c.length)]=b}return d}function R(a){var b=D.createElement("div");b.innerHTML=a;return b=b.firstChild}function V(a,b,c){function d(f,g){this.id=Ea++;this.name=a;this.className="webim-"+a;this.options=G({},d.defaults,g);if(this.element=f||this.template&&R(this.template())||this.options.template&&R(X(this.options.template))){this.options.className&&H(this.element,this.options.className);this.$=ca(this.element)}S(this._init)&&this._init();S(this._initEvents)&&this._initEvents()}d.defaults=
b;Ha.on(d);G(d.prototype,V.prototype,c);B[a]=d}function Q(a,b){B.apps[a]=b||{}}function ea(a,b){return b?a=="b"||a=="buddy"||a=="chat"?"b_"+b:"r_"+b:a}function P(a){return a=="b"||a=="buddy"||a=="chat"?"buddy":"room"}function v(){D.selection&&(this.caretPos=D.selection.createRange())}function o(){return"xx4xyxyxxxyxyyxy".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a=="x"?b:b&3|8).toString(16)})}var L=webim.idsArray,S=webim.isFunction,W=webim.isArray,ba=webim.isObject,ma=webim.trim,
pa=webim.makeArray,G=webim.extend,A=webim.each,ha=webim.grep,Y=webim.ajax,ia=webim.model,Ha=webim.ClassEvent,na=webim.route,va=webim.map,Ba=false,Ca=[],wa=false;h.timeSkew=0;h.init=function(a){h.timeSkew=(new Date).getTime()-parseFloat(a)};G(h.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();
if(a<=0)return p("dt:today");else if(a<864E5)return p("dt:yesterday")}return p("dt:monthdate",{month:p(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var E=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(c){G(b,c);if(!y.Audio&&navigator.userAgent.indexOf("MSIE")>=0){c=D.createElement("bgsound");
c.id="webim-bgsound";c.src="#";c.autostart="true";c.loop="1";D.getElementById("webim-flashlib-c").appendChild(c)}},play:function(c){c=Da(c)?c:b[c];if(a)if(y.Audio){if(!d)var d=new Audio;d.src=c;d.play()}else if(navigator.userAgent.indexOf("MSIE")>=0)try{D.getElementById("webim-bgsound").src=c?c:"/sound/sound.mp3"}catch(f){}}}}(),Ja=function(){var a=false;z(y,"focus",function(){a=false});z(y,"blur",function(){a=true});var b=D.title,c=0,d=false;return function(f,g){if(a){if(k){clearInterval(k);c=0;
d=false}var k=setInterval(function(){c++;d=!d;if(c==g||!a){clearInterval(k);c=0;d=false}D.title=d?"["+f+"]"+b:b},1500)}}}(),Ga={},Ia=function(a,b){return Ga[b]||""};p.locale="zh-CN";p.dictionary={};p.store=function(a,b){var c=p.dictionary;ba(c[a])||(c[a]={});G(c[a],b)};Ha.on(B);G(B.prototype,{render:function(){var a=this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),
b=this.options;this.layout=this.addApp(b.layout||"layout",b.layoutOptions);a.setting.get("play_sound")?E.enable():E.disable();a.bind("online",function(c,d){h.init(d.server_time)});a.setting.bind("update",function(c,d,f){if("play_sound"==d)f?E.enable():E.disable()})},addApp:function(a,b){var c=B.apps[a];if(c)return S(c)&&c.apply(this,[b])},initSound:function(a){E.init(a||this.options.soundUrls)}});var qa=function(a,b){if(b===ka)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+
parseInt(b);a.innerHTML=b.toString();M(a)}else{a.innerHTML="0";C(a)}return b},X=function(){function a(d,f){return b&&b[f]!=ka?b[f]:p(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(d,f){if(!d)return"";b=f;return d.replace(c,a)}}(),T={add:function(a,b,c){a=B[a].prototype;for(var d in c){a.plugins[d]=a.plugins[d]||[];a.plugins[d].push([b,c[d]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var d=0;d<b.length;d++)a.options[b[d][0]]&&b[d][1].apply(a.element,c)}},Ea=1;G(V.prototype,
{_init:function(){}});G(B,{version:"5.4 ",widget:V,app:Q,plugin:T,i18n:p,date:h,ready:function(a){e();Ba?a():Ca.push(a)},createElement:R,openChatbox:I,defaults:{},apps:{}});webim.ui=B;V("window",{isMinimize:false,minimizable:true,detachable:false,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":detach" title="<%=detach%>" class="webim-window-detach" href="#detach"><em class="ui-icon ui-icon-arrowthick-1-ne"><%=detach%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){J(this.$.content,a)},subHeader:function(a){J(this.$.subHeader,a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&C(c.minimize);!b.maximizable&&C(c.maximize);!b.detachable&&C(c.detach);if(!b.closeable){C(c.tabClose);C(c.close)}b.isMinimize?this.minimize():this.restore();this.position={right:0,bottom:0};if(b.detached){this.position.right=
b.detached.right;this.position.bottom=b.detached.bottom;this.detach()}b.onlyIcon?C(c.tabTitle):oa(c.tabTip);b.count&&this.notifyUser("information",b.count);Fa(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(qa(c.tabCount,b)){H(c.tab,"ui-state-highlight");O(c.tab,"ui-state-default")}},_count:function(){return qa(this.$.tabCount)},title:function(a,b){var c=this.$,d=c.tabIcon;if(b)if(Da(b)){d.className="webim-icon";d.style.backgroundImage="url("+b+")"}else d.className=
"webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;d=this.options.titleVisibleLength;if(a){for(var f=0,g=[],k=a.split(""),j=k.length,n=0;n<j;n++)if(f>=d||f<0)break;else{if(k[n].charCodeAt(0)>255)f+=2;else f++;g.push(k[n])}d=g.join("")}else d=a;(c.tabTitle.innerHTML=d)&&a&&d.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){fa(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));
this.trigger("displayStateChange",[a])},active:function(){return la(this.element,"webim-window-active")},activate:function(){if(!this.active()){H(this.element,"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){O(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;this.isDetached()?C(a.tab):fa(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();qa(a.tabCount,
0)},maximize:function(){var a=this,b=a.$.window;if(a.isMaximize()){y.onresize=null;O(b,"webim-maximized-window");a._changeState("restore")}else{H(b,"webim-maximized-window");a._setVisibile();a._changeState("maximize");y.onresize=function(){a._changeState("maximize")}}},restore:function(){var a=this.$.window;if(!la(this.element,"webim-window-normal"))if(la(a,"webim-maximized-window"))this.maximize();else{this._setVisibile();this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){M(this.$.tab);
fa(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");oa(this.element)},detach:function(){var a=this.position,b=this.$.window,c=this.$.detach;if(!this.isDetached()){C(this.$.tab);b.style.bottom=a.bottom+"px";b.style.right=a.right+"px";fa(c.firstChild,"ui-icon-arrowthick-1-ne","ui-icon-arrowthick-1-sw");this.detached=true}},isDetached:function(){return this.detached||false},attach:function(){var a=
this.position,b=this.$.window,c=this.$.detach;M(this.$.tab);a.right=0;a.bottom=0;b.style.bottom="26.4px";b.style.right="0px";fa(c.firstChild,"ui-icon-arrowthick-1-sw","ui-icon-arrowthick-1-ne");this.detached=false},_beforeMove:function(a){var b=this.position,c=this.$.window;if(c.style.right)b.right=parseInt(c.style.right);if(c.style.bottom)b.bottom=parseInt(c.style.bottom);b.right=b.right||0;b.bottom=b.bottom||0;b.mouseX=a.pageX||a.clientX;b.mouseY=a.pageY||a.clientY},move:function(a){var b=this.position,
c=this.$.window,d=(a.pageX||a.clientX)-b.mouseX,f=(a.pageY||a.clientY)-b.mouseY;b.mouseX=a.pageX||a.clientX;b.mouseY=a.pageY||a.clientY;b.right-=d;b.bottom-=f;c.style.right=b.right+"px";c.style.bottom=b.bottom+"px"},_initEvents:function(){var a=this,b=a.$,c=b.tab,d=b.header,f=function(k){ja(k);F(k)};if(a.options.detachable){z(b.detach,"click",function(k){a.isDetached()?a.attach():a.detach();f(k)});var g=function(k){a.move(k)};z(d,"mouseover",function(){d.style.cursor=a.isDetached()?"move":"default"});
z(d,"mousedown",function(k){if(a.isDetached()){a._beforeMove(k);z(d,"mousemove",g)}});z(d,"mouseup",function(){if(d.addEventListener)d.removeEventListener("mousemove",g,false);else{d.detachEvent("onmousemove",d["mousemove"+g]);d["mousemove"+g]=null}})}z(c,"click",function(k){a.isMinimize()?a.restore():a.minimize();f(k)});z(c,"mouseover",function(){H(this,"ui-state-hover");O(this,"ui-state-default")});z(c,"mouseout",function(){O(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&H(this,
"ui-state-default")});z(c,"mousedown",f);U(c);A(ta(b.actions.firstChild),function(k,j){ua(j,"ui-state-hover")});A(["minimize","maximize","close","tabClose"],function(k,j){z(b[j],"click",function(n){this.disable||a[j]();f(n)});z(b[j],"mousedown",f)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return la(this.element,"webim-window-maximize")},isMinimize:function(){return la(this.element,"webim-window-minimize")}});var Fa=function(){var a=false,b=
function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},d=function(){this&&a==this&&(a=false)};z(D,"mousedown",function(f){f=ya(f);for(var g;f;)if(f.id==":webim-window"){g=f;break}else f=f.parentNode;if(g)(f=g.window)&&f.activate();else b()});return function(f){if(f.active()){b();a=f}f.bind("activate",c);f.bind("deactivate",d)}}();Q("layout",function(a){function b(r){if(f)return q.updateAllChat();f=true;var x=j.get("tabs"),w=j.get("tabIds"),N=j.get("p"),Z=j.get("a");
w&&w.length&&x&&A(x,function($,aa){var da=$.slice(2),sa=$.slice(0,1);if(!(sa=="r"&&!r.room.get(da))){q.addChat(sa,da,{},{isMinimize:true});q.chat($).window.notifyUser("information",aa.n)}});N&&(q.prevCount=N)&&q._fitUI();Z&&q.focusChat(Z)}function c(){var r={};A(q.tabs,function(x,w){r[x]={n:w._count()}});j.set({tabs:r,tabIds:q.tabIds,p:q.prevCount,a:q.activeTabId})}a=a||{};var d=this.im,f=false,g=d.buddy,k=d.history,j=d.status,n=d.setting,u=d.room,q=this.layout=new B.layout(null,G({chatAutoPop:d.setting.get("msg_auto_pop")},
a,{ui:this}));d.setting.get("minimize_layout")?q.collapse():q.expand();d.bind("beforeOnline",function(){q.changeState("ready")}).bind("online",function(r,x){q.changeState("active");q.options.user=x.user;b(d)}).bind("offline",function(r,x){x=="offline"&&q.removeAllChat();q.updateAllChat();q.changeState("stop")});n.bind("update",function(r,x,w){if("msg_auto_pop"==x)q.options.chatAutoPop=w;else if("minimize_layout"==x)w?q.collapse():q.expand()});g.bind("online",function(r,x){q.updateChat("buddy",x)}).bind("offline",
function(r,x){q.updateChat("buddy",x)}).bind("update",function(r,x){q.updateChat("buddy",x)});q.bind("collapse",function(){n.set("minimize_layout",true)});q.bind("expand",function(){n.set("minimize_layout",false)});q.bind("displayUpdate",function(){c()});(function(){u.bind("memberAdded",function(r,x,w){(r=q.chat("room",x))&&r.addMember(w.id,w.nick,w.id==d.data.user.id)}).bind("memberRemoved",function(r,x,w){(r=q.chat("room",x))&&r.removeMember(w.id,w.nick)}).bind("updated",function(r,x){var w=q.chat("room",
x.id);w&&w.updateRoom(x)})})();d.bind("message",function(r,x){for(var w=false,N=x.length,Z,$=d.data.user.id,aa,da,sa=0;sa<N;sa++){Z=x[sa];aa=Z.id;type=Z.type;(da=q.chat(type,aa))&&da.status("");if(!da){Z.type==="chat"?q.addChat(type,aa,null,null,Z.nick):q.addChat(type,aa);da=q.chat(type,aa)}da&&n.get("msg_auto_pop")&&!q.activeTabId&&q.focusChat(aa);da.window.notifyUser("information","+1");aa=da.window.pos;aa==-1&&q.setNextMsgNum("+1");aa==1&&q.setPrevMsgNum("+1");if(Z.from!=$)w=true}if(w){E.play("msg");
Ja(p("new message"),5)}});d.bind("status",function(r,x){A(x,function(w,N){var Z=d.data.user.id,$=N.from;if(!(Z!=N.to&&Z!=N.from))(Z=q.chat("buddy",$))&&Z.status(N.show)})});(function(){k.bind("chat",function(r,x,w){(r=q.chat("chat",x))&&r.history.add(w)});k.bind("grpchat",function(r,x,w){(r=q.chat("grpchat",x))&&r.history.add(w)});k.bind("clear",function(r,x,w){(r=q.chat(x,w))&&r.history.clear()})})();return q});V("layout",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">\t<div id=":shortcut" class="webim-shortcut">\t</div>\t<div class="webim-layout-r">\t<div id=":panels" class="webim-panels">\t<div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">\t<div id=":next" class="webim-window-tab webim-panels-next ui-state-default">\t<div id=":nextMsgCount" class="webim-window-tab-count">\t0\t</div>\t<em class="ui-icon ui-icon-triangle-1-w"></em>\t<span id=":nextCount">0</span>\t</div>\t</div>\t<div id=":tabsWrap" class="webim-panels-tab-wrap">\t<div id=":tabs" class="webim-panels-tab">\t</div>\t</div>\t<div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">\t<div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">\t<div id=":prevMsgCount" class="webim-window-tab-count">\t0\t</div>\t<span id=":prevCount">0</span>\t<em class="ui-icon ui-icon-triangle-1-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">\t<div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">\t<em class="ui-icon ui-icon-circle-arrow-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-expand-wrap ui-widget">\t<div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">\t<em class="ui-icon ui-icon-circle-arrow-w"></em>\t</div>\t</div>\t</div>\t<div id=":widgets" class="webim-widgets">\t</div>\t</div>\t</div></div>\t</div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">\t<div class="webim-window-tab-tip">\t<strong><%=title%></strong>\t</div>\t<em class="webim-icon" style="background-image:url(<%=icon%>)"></em>\t</a>\t</div>',chatApp:"chat"},{_init:function(a,b){b=this.options;G(this,{window:y,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},
tabIds:[],nextCount:0,prevCount:0});b.unscalable&&H(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((D.compatMode==="CSS1Compat"&&D.documentElement.clientWidth||D.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70-105)/this.tabWidth);this._fitUI();this.options.disableResize||this._autoResizeWindow();this._ready=
true},_autoResizeWindow:function(){var a=this.$.widgets.offsetWidth;for(var b in this.widgets){var c=this.widgets[b]&&this.widgets[b].window;if(c=c&&c.$&&c.$.window)c.style.width=a+"px"}},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,d=b.length,f=this.prevCount;if(!(d<=c)){if(a){for(var g=0,k=0;k<d;k++)if(b[k]==a){g=k;break}if(g<=f)f=g;else if(g>=f+c)f=g-c+1}else f=d-c;this.prevCount=f}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,d=this.tabs,
f=this.tabIds,g=f.length,k=0,j=0,n=0;n<g;n++){var u=d[f[n]];if(n<b||n>=c)if(a)M(u.element);else{this.activeTabId==f[n]&&u.minimize();var q=u._count();if(n<b){j+=q;u.pos=1}else{k+=q;u.pos=-1}C(u.element)}else{u.pos=0;M(u.element)}}if(!a){this.setNextMsgNum(k);this.setPrevMsgNum(j)}},setNextMsgNum:function(a){qa(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){qa(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,d=b.nextCount;if(d>0&&a==-1||c>0&&a==1){b.slideing=true;
if(d==1&&a==-1||c==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var f=b.$.tabs,g=parseFloat(f.style.left);c=-1*b.tabWidth*b.nextCount;var k=parseInt(500/13),j=1,n=(c-g)/k,u=setInterval(function(){f.style.left=g+n*j+"px";if(j==k){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(u)}else j++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,
c=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,d=this.nextCount;if(b<=a)c=d=0;else{d=b-a-c;d=d<0?0:d;c=b-a-d}this.prevCount=
c;this.nextCount=d},_updateCountUI:function(){var a=this.$,b=this.prevCount,c=this.nextCount;c<=0?H(a.next,"ui-state-disabled"):O(a.next,"ui-state-disabled");b<=0?H(a.prev,"ui-state-disabled"):O(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display="block";a.prev.style.display="block"}else{C(a.next);C(a.prev)}a.nextCount.innerHTML=c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;z(a.window,"resize",function(){if(c){c=true;a.buildUI()}});z(b.next,
"mousedown",function(){a._slide(-1)});z(b.next,"mouseup",function(){a._slideUp()});U(b.next);z(b.prev,"mousedown",function(){a._slide(1)});z(b.prev,"mouseup",function(){a._slideUp()});U(b.prev);z(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});z(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});ua(b.collapse,"ui-state-hover","ui-state-default");ua(b.expand,"ui-state-hover","ui-state-default")},
isMinimize:function(){return la(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||H(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&O(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,
b){b!="minimize"&&A(this.widgets,function(c,d){d.window!=a&&d.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,d){var f=this;b=G(b,{closeable:false,subHeader:a.header});var g=a.element;b=new B.window(null,b);b.html(g);f.$[d?d:"widgets"].insertBefore(b.element,c&&f.widgets[c]?f.widgets[c].window.element:null);a.window=b;b.bind("displayStateChange",function(k,j){f._widgetStateChange(this,j)});f.widgets[a.name]=a},focusChat:function(a,b){b=
ea(a,b);var c=this.tabs[b],d=this.panels[b];c&&c.isMinimize()&&c.restore();d&&d.focus()},chat:function(a,b){return this.panels[ea(a,b)]},updateChat:function(a,b){b=pa(b);for(var c,d=b.length,f,g=0;g<d;g++){c=b[g];(f=this.panels[ea(a,c.id)])&&f.update(c)}},updateAllChat:function(){A(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=ha(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,
b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{var d=this.tabs[c];c&&c!=a&&!d.isDetached()&&d.minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,c,d,f){a=P(a);var g=this,k=g.panels,j=ea(a,b);if(g.chat(a,b))return g.tabs[j];d=g.tabs[j]=(new B.window(null,G({isMinimize:g.activeTabId||!g.options.chatAutoPop,tabWidth:g.tabWidth-
2,detachable:g.options.detachable||false,maximizable:g.options.maximizable||false,titleVisibleLength:9},d))).bind("close",function(){g._onChatClose(j)}).bind("displayStateChange",function(n,u){g._onChatChange(j,u)});a=g.options.ui.addApp(g.options.chatApp,G({id:b,type:a,nick:f,window:d},c));k[j]=a;g.tabIds.push(j);g.$.tabs.insertBefore(d.element,g.$.tabs.firstChild);!d.isMinimize()&&g._changeActive(j);g._fitUI();return d},removeChat:function(a,b){var c=this.tabs[ea(a,b)];c&&c.close()},removeAllChat:function(){A(this.tabs,
function(a,b){b.close()})},addShortcut:function(a){var b=this;if(W(a))A(a,function(f,g){b.addShortcut(g)});else if(ba(a)){var c=b.$.shortcut,d=b.options.tpl_shortcut;if(!(c.childNodes.length>b.options.shortcutLength+1)){d=R(X(d,{title:p(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));ua(d.firstChild,"ui-state-hover");c.appendChild(d)}}}});V("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},
{_init:function(){T.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=pa(a);var b=this,c=a.length,d=[];if(c){for(var f=0;f<c;f++)d.push(b._renderMsg(a[f]));a=R("<div>"+d.join("")+"</div>");d=a.getElementsByTagName("img");f=0;for(c=d.length;f<c;f++)z(d[f],"load",function(){b.trigger("update")});b.$.content.appendChild(a);b.trigger("update")}},notice:function(a,b){this.$.content.appendChild(R('<div class="webim-history-notice ui-state-default ui-state-'+
a+'">'+b+"</div>"));this.trigger("update")},_renderMsg:function(a){a=G({},a);T.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,d=a.timestamp,f=a.body,g=true,k=this._lastLogItem,j=[],n;n=a.nick;if(k&&k.to==c&&k.from==b&&d-k.timestamp<6E4)g=false;if(g){this._lastLogItem=a;b=new h(d);j.push('<h4><span class="webim-gray">');j.push(b.getDay(true));j.push(" ");j.push(b.getTime());j.push("</span>");j.push(n);j.push('</h4><hr class="webim-line ui-state-default" />')}a.style?j.push('<p style="'+
a.style+'">'):j.push("<p>");j.push(f);j.push("</p>");return j.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,d=new Date,f=[];c.setTime(a);b&&d.setTime(b.timestamp);if(!b||c.getDate()!=d.getDate()||c.getMonth()!=d.getMonth()){f.push("<h5>");f.push((new h(a)).getDay(true));f.push("</h5>")}return f.join("")},ui:function(a){return G({element:this.element,$:this.$},a)},plugins:{}});var Ka=function(){function a(d,f,g,k,j,n,u,q){if(f)return'<a href="'+(f=="www."?"http://"+d:d)+
'"'+c+">"+d+"</a>";if(k)return'<a class="webim-img" href="'+n+'"'+c+'><img src="'+(q||n)+'" alt="'+(j||n)+'"/></a>';return'<a class="webim-file" href="'+n+'"'+c+">"+(j||n)+"</a>"}function b(d,f){c+=" "+d+'="'+f+'"'}var c;return function(d,f){c="";f&&ba(f)&&A(f,b);return d.replace(/(https?:\/\/|www\.)([^\s<]+)|(\!?)\[([^\]]*)\]\(([^\)]+)\)(\(([^\)]+)\))?/ig,a)}}();B.history.defaults.parseMsg=true;T.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=za(c);c=Ka(c,{target:"_blank"});b.msg.body=
c}});B.history.defaults.emot=true;T.add("history","emot",{render:function(a,b){b.msg.body=B.emot.parse(b.msg.body)}});V("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;A(b.firstChild.childNodes,function(c,d){z(d,"click",function(){O(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');A(a,function(c,
d){var f=d.src,g=d.t?d.t:d.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(g);b.push('" alt="');b.push(d.q[0]);b.push('" rel="');b.push(d.q[0]);b.push('" /></li>')});b.push("</ul>");return X(this.options.template,{emots:b.join("")})},toggle:function(){ga(this.element,"webim-emot-show")}});G(B.emot,{emots:[{t:"smile",src:"smile",q:[":)"]},{t:"smile_big",src:"smile-big",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad",q:[":(",":-("]},{t:"wink",src:"wink",q:[";)",";-)"]},{t:"tongue",
src:"tongue",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock",q:["=-O","=-o"]},{t:"kiss",src:"kiss",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool",q:["8-)"]},{t:"embarrassed",src:"embarrassed",q:[":-["]},{t:"crying",src:"crying",q:[":'("]},{t:"thinking",src:"thinking",q:[":-/",":-\\"]},{t:"angel",src:"angel",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth",q:[":-!"]},{t:"shout",src:"shout",q:[">:o",
">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=G({dir:"webim/static/emot/default",ext:"png"},a);if(a.emots)b.emots=a.emots;var d=a.dir+"/",f=a.ext;A(b.emots,function(g,k){if(k&&k.src)k.src=d+k.src+"."+f;k&&k.q&&A(k.q,function(j,n){c[n]=g})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&A(b,function(d,f){var g=c[f],k=g.src,j=g.t?g.t:g.q[0],n=[];n.push('<img src="');n.push(k);n.push('" title="');n.push(j);n.push('" alt="');n.push(g.q[0]);n.push('" />');d=za(d);d=d.replace(RegExp("(\\"+
".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(d,"g"),n.join(""))});return a}});V("upload",{template:'<div class="webim-upload ui-widget-content"><form class="ui-helper-clearfix" id=":form" method="POST" enctype="multipart/form-data" encoding="multipart/form-data"><input id=":input" type="file" name="files" /><input id=":submit" class="ui-state-default ui-corner-all webim-upload-submit" type="submit" value="<%=upload%>" /></form></div>'},{_init:function(){var a=this;
a.$.form.setAttribute("action",na("upload"));t(a.$.form,function(b){a.$.submit.disabled=false;if(b=b&&b[0])if(!b.url||b.error)alert(b.error||"Upload error");else{for(var c="",d=["image/jpeg","image/jpg","image/gif","image/png"],f=0;f<d.length;f++)if(d[f]==b.type){c="!";break}c+="["+(b.name||"").replace(/\[|\]/ig,"")+"]("+b.url+")";if(b.thumbnailUrl)c+="("+b.thumbnailUrl+")";try{a.$.form.reset();a.$.input.value=""}catch(g){}a.toggle();a.trigger("upload",c)}else alert("Upload error")},function(){a.$.submit.disabled=
true})},toggle:function(){ga(this.element,"webim-upload-show")}});Q("chat",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=c.room,g=c.history,k=c.data.user,j=a.id,n=a.type;if(n=="room"){var u=g.get("grpchat",j);u||g.load("grpchat",j);var q=c.room.get(j)||{id:j,nick:a.nick||j};q.presence="online";a=G({emot:true,clearHistory:false,member:true,block:true,downloadHistory:false},b.options.roomChatOptions,{info:q,user:c.data.user,history:u,type:n},a);var r=new B.chat(null,a);r.bind("sendMessage",function(x,
w){c.sendMessage(w,function(N){N&&N.message&&r.history.notice("error",N.message)});g.set(w)}).bind("downloadHistory",function(x,w){g.download("grpchat",w.id)}).bind("select",function(x,w){if(!(w.id===k.id&&!d.get(k.id))){w.presence="online";d.presence(w);b.layout.addChat("buddy",w.id,w.nick);b.layout.focusChat("buddy",w.id)}}).bind("block",function(x,w){f.block(w.id)}).bind("unblock",function(x,w){f.unblock(w.id)}).bind("destroy",function(){r.options.info.blocked&&f.leave(j)});setTimeout(function(){r.options.info.blocked?
f.join(j):f.loadMember(j)},500);W(q.members)&&A(q.members,function(x,w){r.addMember(w.id,w.nick,w.presence=="offline"||w.show=="invisible")});f.bind("memberLeaved",function(x,w,N){w==j&&r.history.notice("highlight",p("user leaved notice",{name:N.nick}))}).bind("memberJoined",function(x,w,N){w==j&&r.history.notice("highlight",p("user joined notice",{name:N.nick}))}).bind("memberOnline",function(x,w,N){w==j&&r.history.notice("highlight",p("member online notice",{name:N.nick}))}).bind("memberOffline",
function(x,w,N){w==j&&r.history.notice("highlight",p("member offline notice",{name:N.nick}))})}else{(u=g.get("chat",j))||g.load("chat",j);q=c.buddy.get(j)||{id:j,nick:a.nick||j};a=G({emot:true,clearHistory:true},b.options.buddyChatOptions,{info:q,user:c.data.user,history:u,block:false,member:false,msgType:"chat"},a);r=new B.chat(null,a);c.buddy.get(j)||c.buddy.update(j);r.bind("sendMessage",function(x,w){c.sendMessage(w,function(N){N&&N.message&&r.history.notice("error",N.message)});g.set(w)}).bind("sendStatus",
function(x,w){c.sendStatus(w)}).bind("clearHistory",function(x,w){g.clear("chat",w.id)}).bind("downloadHistory",function(x,w){g.download("chat",w.id)})}return r});V("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t</div></div>',
template:'<div id=":container" class="webim-chat webim-box webim-flex"> \t<div class="webim-chat-notice-wrap1"><div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div> </div>\t<div id=":content" class="webim-chat-content webim-flex webim-box-h"> \t<div id=":sidebar" class="webim-chat-sidebar webim-box"></div><div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div> \t</div> \t<div id=":actions" class="webim-chat-actions"> \t<div id=":toolContent" class="webim-chat-tool-content"></div>\t<div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>\t<table class="webim-chat-t" cellSpacing="0"> \t<tr> \t<td style="vertical-align:top;width:100%;"> \t<div class="webim-chat-input-wrap">\t<textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea> \t</div> \t</td> \t</tr> \t</table> \t</div> \t</div>'},
{_init:function(){var a=this,b=a.element,c=a.options,d=c.window,f=a.history=new B.history(null,{user:c.user,info:c.info});H(b,"webim-chat-"+c.type);a.$.main.insertBefore(f.element,a.$.main.firstChild);a.header=R(X(c.tpl_header));G(a.$,ca(a.header));a._initEvents();d&&a.setWindow(d);c.simple&&C(a.header);a.update(c.info);f.add(c.history);T.call(a,"init",[null,a.ui()]);setTimeout(function(){a._adjustContent()},0)},setWindow:function(a,b){this.window=a;a.subHeader(this.header);!b&&a.html(this.element);
a.title(this.options.info.nick);this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online"&&this.options.info.show!="invisible";if(this.options.user.presence=="online")a?this.notice(""):this.notice(p("buddy offline notice",{name:this.options.info.nick}));else this.notice(p("user offline notice"));T.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;y.setTimeout(function(){try{a.focus()}catch(b){}},
0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var c=this,d=c.$.notice,f=c._noticeTime;f&&clearTimeout(f);if(a)if(b){d.innerHTML=a;M(d);setTimeout(function(){if(c._noticeTxt)d.innerHTML=c._noticeTxt;else C(d,500)},b)}else{c._noticeTxt=a;d.innerHTML=a;M(d)}else{c._noticeTxt=null;C(d)}},_adjustContent:function(){var a=this.$.main;if(a.scrollTop!=a.scrollHeight)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this,b=a.options,c=a.$,d=c.content,
f=c.main;a.window.bind("displayStateChange",function(g,k){if(k=="maximize"){var j=K().y-128;d.style.height=f.style.height=j+"px";if(b.member){var n=c.sidebar.firstChild;n.style.marginTop="0px";n.style.height=j-1+"px";n.style.left="-1px";f.style.marginLeft="8.2em"}}else if(k=="restore"){d.style.height=f.style.height="";if(b.member){n=c.sidebar.firstChild;n.style.marginTop="";n.style.height="";n.style.left="";f.style.marginLeft="0px"}}if(k!="minimize"){y.setTimeout(function(){a.$.input.focus()},0);
a._adjustContent()}}).bind("close",function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"grpchat":"chat",to:c.id,from:b.user.id,nick:b.user.nick,to_nick:c.nick,offline:c.presence!="online"?"true":"false",timestamp:(new Date).getTime()-h.timeSkew,body:a};T.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMessage",[a])},_inputkeypress:function(a){if(a.keyCode==
13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=ya(a),c=b.value;if(ma(c).length){this.sendMessage(c);b.value="";F(a)}}else this._typing()},_onFocusInput:function(a){var b=this;ya(a);(y.getSelection?y.getSelection().toString():D.selection?D.selection.createRange().text:"")||y.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=p("input notice"),d=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(p("clear history notice"),
3E3)});z(d,"keyup",function(){v.call(this)});z(d,"click",v);z(d,"select",v);z(d,"focus",function(){O(this,"webim-gray");if(this.value==c)this.value=""});z(d,"blur",function(){if(this.value==""){H(this,"webim-gray");this.value=c}});z(d,"keypress",function(f){a._inputkeypress(f)});z(b.main,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.setAttribute("target",a.target||this.options.target||"");b.userPic.firstChild.setAttribute("defaultsrc",
a.default_avatar?a.default_avatar:"");setTimeout(function(){if(a.avatar||a.default_avatar)try{b.userPic.firstChild.setAttribute("src",a.avatar||a.default_avatar)}catch(c){}},100);b.userStatus.innerHTML=Aa(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(c.value==p("input notice"))c.value="";if(b){a||(a="");if(c.setSelectionRange){var d=c.value,f=c.selectionStart,g=c.selectionEnd,k=d.substring(0,f);d=d.substring(g);g=a.length;c.value=
k+a+d;c.setSelectionRange(f+g,f+g)}else if(D.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",[{to:this.options.info.id,show:a}])}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=y.setTimeout(function(){a.sendStatus("clear")},
6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,d="";d=a=="clear"?"":c+p(a);b.innerHTML=d;this._adjustContent();this._setST&&clearTimeout(this._setST);if(d!="")this._setST=y.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return G({self:this,$:this.$,history:this.history},a)},plugins:{}});B.chat.defaults.emot=true;T.add("chat","emot",{init:function(a,b){var c=b.self,d=c.emot=new B.emot;d.bind("select",
function(g,k){c.focus();c.insert(k,true)});var f=R(X('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));z(f,"click",function(g){c.upload&&O(c.upload.element,"webim-upload-show");F(g);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});B.chat.defaults.upload=false;T.add("chat","upload",{init:function(a,b){var c=b.self,d=c.upload=new B.upload;d.bind("upload",function(g,k){c.sendMessage(k)});var f=R(X('<a href="#chat-upload" title="<%=upload%>"><em class="webim-icon webim-icon-upload"></em></a>'));
z(f,"click",function(g){c.emot&&O(c.emot.element,"webim-emot-show");F(g);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});B.chat.defaults.clearHistory=true;T.add("chat","clearHistory",{init:function(a,b){var c=b.self,d=R(X('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));z(d,"click",function(f){F(f);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(d)}});B.chat.defaults.block=
true;T.add("chat","block",{init:function(a,b){var c=b.self,d=c.options.info.blocked,f=c.options.info.nick,g=R('<a href="#chat-block" style="display:'+(d?"none":"")+'" title="'+p("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),k=R('<a href="#chat-block" style="display:'+(d?"":"none")+'" title="'+p("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');z(g,"click",function(j){F(j);C(g);M(k);c.trigger("block",[c.options.info])});z(k,"click",
function(j){F(j);C(k);M(g);c.trigger("unblock",[c.options.info])});b.$.tools.appendChild(g);b.$.tools.appendChild(k)}});B.chat.defaults.member=true;G(B.chat.prototype,{updateRoom:function(a){for(var b=this,c=b.$.member;c.hasChildNodes();)c.removeChild(c.lastChild);b.memberLi={};b.$.memberCount.innerHTML="0";A(a.members,function(d,f){b.addMember(f.id,f.nick,f.presence=="offline"||f.show=="invisible")})},addMember:function(a,b,c){var d=this,f=d.memberLi;if(!f[a]){c=R("<li"+(c?' class="ui-state-disabled"':
"")+'><a  href="'+a+'">'+b+"</a></li>");z(c.firstChild,"click",function(g){F(g);d.trigger("select",[{id:a,nick:b}])});f[a]=c;d.$.member.appendChild(c);d.$.memberCount.innerHTML=parseInt(d.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});T.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var d=R(X('<div class="webim-box webim-flex  webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>:<span id=":memberCount">0</span></h4><ul id=":ul" class="webim-flex"></ul></div>')),
f=ca(d);c.member=f.ul;c.memberCount=f.memberCount;c.sidebar.appendChild(d)}});B.chat.defaults.downloadHistory=true;T.add("chat","downloadHistory",{init:function(a,b){var c=b.self,d=R(X('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));z(d,"click",function(f){F(f);c.trigger("downloadHistory",[c.options.info])});b.$.tools.appendChild(d)}});Q("setting",function(a){var b=this.im.setting,c=this.layout,d=this.setting=
new B.setting(null,a);c.addWidget(d,{title:p("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,g,k){typeof k!="object"&&d.check_tag(g,k)});d.bind("change",function(f,g,k){b.set(g,k)})});V("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},
{_init:function(){var a=this.options.copyright;if(a){a=a===true?'<p style="margin: 5px 10px;"><a class="webim-gray" href="http://nextalk.im/" target="_blank">Powered by <strong>NexTalk</strong><em>&nbsp5.8</em></a></p>':a;this.element.appendChild(R(a))}},template:function(){var a=this,b=[],c=a.options.data;c&&A(c,function(d,f){f&&typeof f!="boolean"||b.push(a._check_tpl(d,f))});return X(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&A(b,function(d){c[d]&&
a._check_event(c[d])})},_check_tpl:function(a,b){return X(this.options.tpl_check,{label:p(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;z(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var c=this;if(ba(a))A(a,function(g,k){c.check_tag(g,k)});else{var d=c.$,f=d[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=b;else{f=d[a]=R(c._check_tpl(a,b));c._check_event(f);d.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",
[a,b])},destroy:function(){}});Q("user",function(a){a=a||{};var b=this.im,c=new B.user;!a.show&&C(c.element);a.container&&a.container.appendChild(c.element);c.bind("online",function(d,f){b.online(f)}).bind("offline",function(){b.offline()}).bind("presence",function(d,f){b.sendPresence(f)});c.update(b.data.user);b.bind("online",function(){M(c.element);c.update(b.data.user)}).bind("offline",function(){c.show("unavailable")});return c});V("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;z(b.userShowTrigger,"click",function(d){c.style.display=="block"?C(c):M(c);F(d)});A(ta(c.firstChild),function(d,f){z(f,"click",function(g){a._set(this.href.split("#")[1]);C(c);F(g)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=Aa(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_avatar?a.default_avatar:"");setTimeout(function(){if(a.avatar||a.default_avatar)c.userPic.firstChild.setAttribute("src",a.avatar||a.default_avatar)},100);this.show(b)},show:function(a){var b=p(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});Q("login",function(a){a=a||{};var b=this.im,c=new B.login(null,a);a.container&&a.container.appendChild(c.element);c.bind("login",function(d,f){b.online(f)});b.bind("online",function(){c.hide()}).bind("offline",function(d,f,g){f=="online"&&c.showError(g)});return c});V("login",{questions:null,notice:"",template:'<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?A(a,function(c,d){var f=D.createElement("option");f.value=d[0];f.innerHTML=d[1];b.question.appendChild(f)}):C(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;ua(b.submit,"ui-state-hover");z(b.form,"submit",function(c){F(c);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){C(this.element)},show:function(){M(this.element)},
hideError:function(){C(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=p(a);M(b)},destroy:function(){}});Q("buddy",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=b.layout,g=new B.buddy(null,G({title:a.title||p("buddy")},a));f.addWidget(g,{className:"webim-buddy-window",title:a.title||p("buddy"),titleVisibleLength:19,sticky:c.setting.get("buddy_sticky"),isMinimize:!c.status.get("b"),icon:"buddy"});g.bind("select",function(q,r){b.layout.addChat("buddy",r.id);b.layout.focusChat("buddy",
r.id)}).bind("remove",function(q,r){y.confirm(p("Remove Buddy",{name:r.nick}))&&d.remove(r.id)});var k;if(!a.disable_user){k=b.addApp("user",a.userOptions);if(a.is_login){g.window.subHeader(k.element);M(k.element);k=null}}!a.is_login&&!a.disable_login&&b.addApp("login",G({container:g.$.content},a.loginOptions));c.setting.bind("update",function(q,r){if(q=="buddy_sticky")g.window.option.sticky=r});g.window&&g.window.bind("displayStateChange",function(q,r){if(r!="minimize"){d.options.active=true;c.status.set("b",
1);d.complete()}else{c.status.set("b",0);d.options.active=false}});g.bind("search",function(q,r,x){c.buddy.search(r,x)});var j=function(q){return ba(q)?q.id:q},n=function(q){return q.show!="invisible"&&q.presence=="online"},u=function(q){return q.show=="invisible"};d.bind("online",function(q,r){if(a.showUnavailable){g.remove(va(r,j));g.add(r)}else g.add(ha(r,n))});d.bind("offline",function(q,r){if(a.showUnavailable){g.remove(va(r,j));g.add(r)}else g.remove(va(r,j))});d.bind("update",function(q,r){if(a.showUnavailable){g.add(r);
g.update(r)}else{g.add(ha(r,n));g.update(ha(r,n));g.remove(va(ha(r,u),j))}});d.bind("unsubscribe",function(q,r){var x=va(r,j);A(x,function(w,N){b.layout.removeChat("buddy",N)});g.remove(x)});g.offline();c.bind("beforeOnline",function(){g.online()}).bind("online",function(){k&&g.window.subHeader(k.element);g.titleCount()}).bind("offline",function(){g.offline()});return g});V("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><em class="ui-icon ui-icon-triangle-1-s"></em><span><%=title%>(<%=count%>)</span></h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title="" class="webim-buddy-<%=show%>"><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><em class="webim-icon ui-icon ui-icon-trash" style="display:none;cursor:pointer;"></em><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=avatar%>" defaultsrc="<%=default_avatar%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},
{_init:function(){var a=this.options;this.groups={};this.li={};this.li_group={};this.on_li={};this.on_li_group={};this.size=0;this.presences={};a.disable_group&&H(this.element,"webim-buddy-hidegroup");a.simple&&H(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=a.options,d=b.search,f=b.searchInput,g=p("search buddy");z(d.firstChild,"click",function(){f.focus()});f.value=g;z(f,"focus",function(){H(d,"ui-state-active");if(this.value==g)this.value=""});z(f,"blur",function(){O(d,
"ui-state-active");if(this.value=="")this.value=g});z(f,"keyup",function(k){function j(){A(a.groups,function(u,q){C(q.el)});A(a.on_li,function(u,q){C(q)});A(a.li,function(u,q){C(q)});A(a.li,function(u,q){if((q.text||q.innerHTML.replace(/<[^>]*>/g,"")).indexOf(n)>=0){var r=a.li_group[u];r&&M(r.el);M(q)}})}var n=this.value;if(n==ka||n==""){A(a.groups,function(u,q){M(q.el)});A(a.on_li,function(u,q){M(q)});A(a.li,function(u,q){M(q)})}else if(c.search&&c.search=="remote")k.keyCode==13&&a.trigger("search",
[n,j]);else j()})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty,d=this.options,f=0;A(this.presences,function(g,k){k.o&&f++});b&&b.title(this.options.title+"["+f+"/"+(a?a:"0")+"]");a?C(c):M(c);if(d.search&&d.search=="remote")this.scroll(true);else a>8?this.scroll(true):this.scroll(false)},groupTitleCount:function(a){var b=0;if(a.name==p("online_group"))a.title.innerHTML=a.name+"["+a.count+"]";else{A(this.presences,function(c,d){d.o&&d.g==a.name&&b++});a.title.innerHTML=a.name+
"["+b+"/"+a.count+"]"}},scroll:function(a){ga(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=this.window;b&&b.title(this.options.title+"["+p(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");C(a.empty)},offline:function(){var a=
this.$;this.scroll(false);this.removeAll();this.presences={};C(a.empty);this.notice("offline")},_updateInfo:function(a,b){var c=b.show?b.show:"available";a.className="webim-buddy-"+c;a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a=a.nextSibling;a=a.nextSibling;a.className="webim-icon webim-icon-"+c;a.setAttribute("title",p(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_avatar?b.default_avatar:"");if(b.avatar||b.default_avatar)a.setAttribute("src",b.avatar||b.default_avatar);
a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=Aa(b.status)||"&nbsp;";return a},showCount:function(a,b){var c=this.li;c[a]&&qa(c[a].firstChild.firstChild,b)},isOnline:function(a){return!(a=="unavailable"||a=="invisible")},_addOne:function(a,b){var c=this.li,d=this.on_li,f=this.li_group,g=this.on_li_group;a.show=a.show||"available";this.options.online_group&&this.isOnline(a.show)&&this._addOne2Grp(a,d,"online_group",g,false);this._addOne2Grp(a,c,a.group||"friend",f,b)},_addOne2Grp:function(a,
b,c,d,f){var g=this,k=a.id,j=g.$.ul;if(!b[k]){if(b===g.li){g.presences[a.id]={o:g.isOnline(a.show),g:p(c)};g.size++}if(!a.default_avatar)a.default_avatar="";a.status=Aa(a.status)||"&nbsp;";a.human_show=p(a.show);a.avatar=a.avatar||"";b=b[k]=R(X(g.options.tpl_li,a));var n=b.firstChild;z(n.firstChild.nextSibling,"click",function(r){g.trigger("remove",[a]);ja(r);F(r)});z(n,"click",function(r){F(r);g.showCount(k,0);g.trigger("select",[a]);this.blur()});n=g.groups;c=p(c);n=n[c];if(!n){n=R(X(g.options.tpl_group));
C(n);if(c==p("stranger"))f=true;if(c==p("online_group"))j.insertBefore(n,j.firstChild);else if(f){j.appendChild(n);g._lastChild=n}else g._lastChild?j.insertBefore(n,j.lastChild):j.appendChild(n);var u=n.lastChild;f=n.firstChild;var q=f.firstChild;j=g.options.collapse;n={name:c,el:n,count:0,online_count:0,title:n.firstChild.lastChild,li:u};g.groups[c]=n;if(j===ka)C(q);else{if(j){fa(q,"ui-icon-triangle-1-s","ui-icon-triangle-1-e");C(u)}z(f,"click",function(){if(la(q,"ui-icon-triangle-1-s")){fa(q,"ui-icon-triangle-1-s",
"ui-icon-triangle-1-e");C(u)}else{fa(q,"ui-icon-triangle-1-e","ui-icon-triangle-1-s");M(u)}})}}n.count==0&&M(n.el);d[k]=n;g.isOnline(a.show)?n.li.insertBefore(b,n.li.firstChild):n.li.appendChild(b);n.count++;g.groupTitleCount(n)}},_updateOne:function(a){var b=this.li,c=this.on_li,d=a.id;b[d]&&this._updateInfo(b[d],a);c[d]&&this._updateInfo(c[d],a);b=a.show||"available";c=p(a.group||"friend");this.presences[a.id]={o:this.isOnline(b),g:c};(a=this.groups[c])&&this.groupTitleCount(a)},update:function(a){a=
pa(a);for(var b=0;b<a.length;b++)this._updateOne(a[b]);this.titleCount()},add:function(a,b){a=pa(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b;a=L(a);for(var c=0;c<a.length;c++){b=a[c];this._removeOne(b,this.on_li,this.on_li_group);this._removeOne(b,this.li,this.li_group)}this.titleCount()},_removeOne:function(a,b,c){var d=b[a];if(d){if(b==this.li){this.size--;delete this.presences[a]}if(group=
c[a]){group.count--;group.count==0&&C(group.el);this.groupTitleCount(group)}oa(d);delete b[a]}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},active:function(a){if(this.options.highlightable){this._actived&&O(this._actived.firstChild,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){H(a.firstChild,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}},destroy:function(){}});Q("room",function(a){function b(k){var j=k.nick;k=k.all_count===0?
G({},k,{group:"group",nick:j}):G({},k,{group:"group",nick:j+"["+(parseInt(k.count)+"/"+parseInt(k.all_count||k.count))+"]"});f.updateChat(k);k.blocked&&(k.nick=j+"["+p("blocked")+"]");g.li[k.id]?g.update(k):g.add(k)}var c=this.im,d=c.room,f=this.layout,g=this.room=(new webim.ui.room(null,G(a,{buddy:c.buddy,user:c.data.user}))).bind("select",function(k,j){f.addChat("room",j.id);f.focusChat("room",j.id)}).bind("discussion",function(k,j,n){j.id=j.id||o();d.invite(j.id,j.nick,n,function(){f.addChat("room",
j.id);f.focusChat("room",j.id)})}).bind("exit",function(k,j){var n=d.get(j);if(n&&y.confirm(p("Exit Room",{name:n.nick}))){d.leave(j);f.removeChat("room",j)}});c.bind("event",function(k,j){for(var n=0;n<j.length;n++){var u=j[n].event;u&&u[0]=="invite"&&d.join(u[1],u[2],function(){})}});f.addWidget(g,{title:p("room"),icon:"room",sticky:c.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true});c.setting.bind("update",function(k,j,n){if(j=="buddy_sticky")g.window.options.sticky=n});d.bind("updated",
function(k,j){b(j)}).bind("leaved",function(k,j){g.remove([j])}).bind("blocked",function(k,j){var n=d.get(j);b(n)}).bind("unblocked",function(k,j){var n=d.get(j);b(n)});C(g.$.actions);c.bind("beforeOnline",function(){}).bind("online",function(){M(g.$.actions)}).bind("offline",function(){C(g.$.actions);g.removeAll()});return g});V("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t<div id=":list">\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t<div class="webim-room-content webim-flex">\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t<ul id=":ul"></ul>\t</div>\t</div>\t<div id=":discussion" style="display:none;" class="webim-room-discussion">\t<h4><%=discussion%></h4>\t<div><p><%=discussion name%></p><input id=":name" class="webim-room-discussion-name" type="text" /></div>\t<div><p><%=select discussion buddies%></p><ul class="webim-room-discussion-list ui-widget-content" id=":ul2"></ul></div>\t<div><a id=":confirm" href="#" class="webim-button ui-state-default ui-corner-all"><%=confirm%></a><a id=":cancel" href="#" class="webim-button ui-state-default ui-corner-all"><%=cancel%></a></div>\t</div>\t<div id=":actions" class="webim-room-actions"><a id=":create" href="#" class="webim-button ui-state-default ui-corner-all"><%=create discussion%></a></div>\t</div>',
tpl_li:'<li title=""><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=exit%>" /><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=invite%>" /><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><img width="25" src="<%=avatar%>" defaultsrc="<%=default_avatar%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},
{_init:function(){this.size=0;this.li={};this._count=0;M(this.$.empty);this.options.discussion||C(this.$.create)},_initEvents:function(){var a=this,b=a.$,c=b.search,d=b.searchInput,f=p("search room");z(c.firstChild,"click",function(){d.focus()});d.value=f;z(d,"focus",function(){H(c,"ui-state-active");if(this.value==f)this.value=""});z(d,"blur",function(){O(c,"ui-state-active");if(this.value=="")this.value=f});z(d,"keyup",function(){var g=this.value;A(a.li,function(k,j){g&&(j.text||j.innerHTML.replace(/<[^>]*>/g,
"")).indexOf(g)==-1?C(j):M(j)})});z(b.create,"click",function(g){F(g);a.updateDiscussion()});z(b.confirm,"click",function(g){F(g);a.confirmDiscussion()});z(b.cancel,"click",function(g){F(g);a.confirmDiscussion(true)})},scroll:function(a){ga(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild.nextSibling.nextSibling;a.setAttribute("href",b.url);a=a.firstChild.nextSibling;a.setAttribute("defaultsrc",b.default_avatar?b.default_avatar:"");a.setAttribute("src",b.avatar);a=a.nextSibling;
a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,d=a.id,f=b.$.ul;b.size++;if(!c[d]){if(!a.default_avatar)a.default_avatar="";c=c[d]=R(X(b.options.tpl_li,a));var g=c.firstChild,k=c.firstChild.nextSibling;if(a.temporary){z(g,"click",function(j){F(j);b.trigger("exit",[d])});z(k,"click",function(j){F(j);b.updateDiscussion(a)})}else{C(k);C(g)}z(k.nextSibling,"click",function(j){F(j);b.showCount(d,0);b.trigger("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=
this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=pa(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){C(this.$.empty);a=pa(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,d=this.li;a=L(a);for(var f=0;f<a.length;f++){b=a[f];if(c=d[b]){oa(c);delete d[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){},
confirmDiscussion:function(a){var b=this.$;C(b.discussion);M(b.list);M(b.actions);if(!a){a=this._discussion||{};a.temporary=true;a.nick=b.name.value||p("discussion");b=b.ul2.getElementsByTagName("input");for(var c=[],d=0;d<b.length;d++){var f=b[d];f.checked&&c.push(f.value)}this.trigger("discussion",[a,c])}},updateDiscussion:function(a){var b=[],c=this.options.buddy.all();this._discussion=a;var d=this.$;d.name.value=a&&a.nick.replace(/\([^\)]*\)/ig,"")||p("discussion name input",{name:this.options.user.nick});
for(a=0;a<c.length;a++){var f=c[a];b.push('<li class="'+(f.show&&(f.show=="unavailable"||f.show=="hidden")?"ui-state-disabled":"")+'"><label for="webim-discussion-'+f.id+'"><input id="webim-discussion-'+f.id+'" type="checkbox" name="buddy" value="'+f.id+'" />'+f.nick+"-"+p(f.group)+"</label></li>")}d.ul2.innerHTML=b.join("");M(d.discussion);C(d.list);C(d.actions)},showCount:function(a,b){var c=this.li;c[a]&&qa(c[a].firstChild.nextSibling.nextSibling.firstChild,b)},active:function(a){if(this.options.highlightable){this._actived&&
O(this._actived.firstChild.nextSibling,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){H(a.firstChild.nextSibling,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}}});Q("menu",function(a){var b=this.layout;a=this.menu=new B.menu(null,a);b.addWidget(a,{title:p("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")});V("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&C(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&A(c,function(d,f){b.push(a._li_tpl(f))});return X(a.options.template,{list:b.join("")})},_li_tpl:function(a){return X(this.options.tpl_li,{title:p(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>
300)a.style.height="300px"},add:function(a){var b=this;if(W(a))A(a,function(d,f){b.add(f)});else{var c=b.$;C(c.empty);c.ul.appendChild(R(b._li_tpl(a)))}},destroy:function(){}});Q("chatlink",function(a){var b=this,c=b.im,d=b.chatlink=(new webim.ui.chatlink(null,a)).bind("select",function(k,j){b.layout.addChat("buddy",j);b.layout.focusChat("buddy",j)}),f=function(k){return k.show!="invisible"&&k.presence=="online"},g=function(k){return k.show=="invisible"};c.buddy.bind("online",function(k,j){d.add(ha(j,
f))}).bind("update",function(k,j){d.add(ha(j,f));d.remove(ha(j,g))}).bind("offline",function(k,j){d.remove(j)});c.bind("beforeOnline",function(k,j){j.chatlink_ids=d.idsArray()}).bind("online",function(){d.remove(c.data.user)}).bind("offline",function(){d.removeAll()})});V("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,
/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,link_class:null,off_link_class:null,link_wrap:null,space_wrap:null},{_init:function(){function a(Z,$){if(!Z)return false;if(!$)return false;for(var aa=$.length,da=0;da<aa;da++){var sa=$[da].exec(Z);if(sa&&sa[1])return sa[1]}return false}var b=this.list={},c=this.options,d=this.anthors={},f=c.link_href,g=c.space_href,k=c.space_id,j=c.off_link_class,n=c.link_class,u=c.space_class,q=c.space_wrap||D;(c=(c.link_wrap||
D).getElementsByTagName("a"))&&A(c,function(Z,$){var aa=a($.href,f),da=$.innerHTML;if(aa&&ta($.firstChild).length==0&&da&&(!$.className||!n||n.test($.className))&&(!$.className||!j||!j.test($.className))){d[aa]?d[aa].push($):d[aa]=[$];b[aa]={id:aa,name:da}}});if(g=a(y.location.href,g)){b[g]=G(b[g],{id:g});q=q.getElementsByTagName("*");c=q.length;for(var r,x,w,N=0;N<c;N++){r=q[N];x=r.className;w=r.id;if(u&&u.test(x)||k&&k.test(w)){r=ta(r.firstChild);if(r.length){r=r[r.length-1];d[g]?d[g].push(r):d[g]=
[r]}break}}}},_temp:function(a){var b=this;a=R(X('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',a));z(a,"click",function(c){b.trigger("select",this.id);ja(c);F(c)});return a},idsArray:function(){var a=[];A(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,c=this.anthors,d=a.length,f,g,k,j,n;for(f=0;f<d;f++){g=a[f];if(g.id&&(k=g.uid||g.id)&&(j=b[k])){n=c[k];if(!j.elements&&n){j.elements=[];for(var u=0;u<n.length;u++)if(n[u].tagName.toLowerCase()==
"li"){j.elements[u]=D.createElement("li");j.elements[u].appendChild(this._temp({id:g.id,title:"",text:p("chat with me")}))}else j.elements[u]=this._temp({id:g.id,title:p("chat with",{name:j.name}),text:""})}n&&A(n,function(q,r){r.parentNode.insertBefore(j.elements[q],r.nextSibling)})}}},remove:function(a){var b=this.list,c=a.length,d,f,g,k;for(d=0;d<c;d++){f=a[d];if(f.id&&(g=f.uid||f.id)&&(k=b[g]))k.elements&&A(k.elements,function(j,n){oa(n)})}},removeAll:function(){A(this.list,function(a,b){b.elements&&
A(b.elements,function(c,d){oa(d)})})}});Q("chatbtn",function(a){var b=this,c=b.im,d=b.chatbtn=(new webim.ui.chatbtn(null,a)).bind("select",function(k,j,n){if(a.chatbox)I(n);else{b.im.online();j=j.substr(13);b.layout.addChat("buddy",j);b.layout.focusChat("buddy",j);if(a&&a.autoInsertlink)(k=b.layout.chat("buddy",j))&&k.insert(y.location.href)}}),f=function(k){return k.show!="invisible"&&k.show!="unavailable"},g=function(k){return k.show=="invisible"};c.models.presence.bind("online",function(k,j){d.on(j)}).bind("update",
function(k,j){d.on(ha(j,f));d.off(ha(j,g))}).bind("offline",function(k,j){d.off(j)});c.bind("beforeOnline",function(k,j){j.chatlink_ids=d.idsArray()}).bind("online",function(){d.off(c.data.user)}).bind("offline",function(){d.offAll()})});V("chatbtn",{wrap:null,elementId:null,hrefRe:[/chat\/([^\/]+)/i],classRe:/webim-chatbtn/},{_init:function(){function a(n,u){if(!n)return false;if(!u)return false;for(var q=u.length,r=0;r<q;r++){var x=u[r].exec(n);if(x&&x[1])return x[1]}return false}var b=this,c=b.list=
{},d=b.options,f=b.anthors={},g=d.hrefRe,k=d.elementId,j=d.classRe;d=d.wrap||D;if(k)d=(d=D.getElementById(k))?[d]:null;else d=d.getElementsByTagName("a");d&&A(d,function(n,u){var q=a(u.href,g),r=u.innerHTML;if(q&&ta(u.firstChild).length==0&&r&&(k||j.test(u.className))){f[q]?f[q].push(u):f[q]=[u];c[q]={id:q,name:r};r=R('<i class="webim-chaticon"><em></em></i>');u.appendChild(r);u.icon=r;u.title=p("offline");u.id="webim-chatid-"+q;webim.isMobile()||z(u,"click",function(x){b.trigger("select",[this.id,
u.href]);ja(x);F(x)})}})},idsArray:function(){var a=[];A(this.list,function(b){a.push(b)});return a},on:function(a){var b=this.list,c=this.anthors,d=a.length,f,g,k;for(f=0;f<d;f++){g=a[f];if(g.id&&(k=g.uid||g.id)&&b[k])if(g=c[k])for(var j=0;j<g.length;j++){var n=g[j];n&&n.icon&&H(n.icon,"webim-chaticon-online");n&&(n.title=p("available"))}}},off:function(a){var b=this.list,c=this.anthors,d=a.length,f,g,k;for(f=0;f<d;f++){g=a[f];if(g.id&&(k=g.uid||g.id)&&b[k])if(g=c[k])for(var j=0;j<g.length;j++){var n=
g[j];n&&n.icon&&O(n.icon,"webim-chaticon-online");n&&(n.title=p("unavailable"))}}},offAll:function(){A(this.anthors,function(a,b){b&&A(b,function(c,d){d&&d.icon&&O(d.icon,"webim-chaticon-online");d&&(d.title=p("unavailable"))})})}});ia("notification",{url:"webim/notifications"},{_init:function(){},grep:function(a){return a&&a.text},handle:function(a){a=ha(pa(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){Y({url:na("notifications"),cache:false,context:this,success:this.handle})}});
Q("notification",function(a){var b=this.im,c=this.layout,d=this.notification=new B.notification(null,a),f=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});c.addWidget(d,{title:p("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});f.bind("data",function(g,k){d.window.notifyUser("information","+"+k.length);d.add(k)});setTimeout(function(){f.load()},2E3)});V("notification",{template:'<div id="webim-notification" class="webim-notification">\t<ul id=":ul"><%=list%></ul>\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&C(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&A(c,function(d,f){b.push(a._li_tpl(f))});return X(a.options.template,{list:b.join("")})},_li_tpl:function(a){return X(this.options.tpl_li,{text:a.text,link:a.link,target:this.options.target||a.target||""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=
this;if(W(a))A(a,function(d,f){b.add(f)});else{var c=b.$;C(c.empty);c.ul.appendChild(R(b._li_tpl(a)))}},destroy:function(){}});ia("ask",{url:"webim/asks"},{_init:function(){},grep:function(a){return a&&a.text},handle:function(a){W(a)&&this.trigger("data",[a])},load:function(){Y({url:na("asks"),cache:false,context:this,success:this.handle})},accept:function(a){var b=this.options;Y({url:na("accept"),cache:false,data:{ticket:b.ticket,askid:a,csrf_token:webim.csrf_token},context:this,success:this.load})},
reject:function(a){var b=this.options;Y({url:na("reject"),cache:false,data:{ticket:b.ticket,askid:a,csrf_token:webim.csrf_token},context:this,success:this.load})}});Q("ask",function(a){var b=this.im,c=this.layout,d=b.ask=new webim.ask(null,{jsonp:b.options.jsonp}),f=this.ask=new B.ask(null,a);f.bind("accept",function(g,k){d.accept(k)}).bind("reject",function(g,k){d.reject(k)});c.addWidget(f,{title:p("ask app"),icon:"ask",sticky:false,onlyIcon:true,isMinimize:true});d.bind("data",function(g,k){k.length&&
f.window.notifyUser("information","+"+k.length);f.addAll(k)});setTimeout(function(){d.load()},1E3)});V("ask",{template:'<div id="webim-ask" class="webim-ask">\t<ul id=":ul"></ul>\t<div id=":empty" class="webim-ask-empty"><%=empty ask%></div>\t</div>',tpl_btn_li:'<li title=""><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=reject%>" /><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=accept%>" /><%=text%></li>',tpl_li:"<li><%=text%></li>"},
{_init:function(){var a=this.options;a.data&&a.data.length&&C(this.$.empty);this._initEvents()},_initEvents:function(){},addAll:function(a){var b=this,c=b.$;if(W(a)){C(c.empty);c.ul.innerHTML="";A(a,function(d,f){b.addOne(f)})}},addOne:function(a){this.$.ul.appendChild(this._li(a))},_li:function(a){var b=this,c,d=a.answer;if(d==0)c=p("Ask Initiate",{name:a.nick,time:a.time});else if(d==1)c=p("Ask Accepted",{name:a.nick,time:a.time});else if(d==2)c=p("Ask Rejected",{name:a.nick,time:a.time});if(d>
0)c=R(X(this.options.tpl_li,{text:c}));else{c=R(X(this.options.tpl_btn_li,{text:c,accept:p("accept"),reject:p("reject")}));d=c.firstChild;z(d.nextSibling,"click",function(f){F(f);b.trigger("accept",[a.id])});z(d,"click",function(f){F(f);b.trigger("reject",[a.id])})}return c},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},destroy:function(){}});Q("visitorstatus",function(){var a=this.im,b=a.status,c=b.get("v_f"),d=b.get("v_l"),f=D.referrer,g=D.location.href,k=D.location.host;
if(f&&f!=c){var j=(ex=/\/\/([^\/]+)/.exec(f))&&ex[1];if(j&&j!=k)b.set("v_f",f);else f=c}else f=c;g!=d&&b.set("v_l",g);var n=g+(f?" | "+p("from")+" "+f:""),u={};a.bind("sendMessage",function(q,r){if(r.to){var x="v_to_"+r.to;if(!u[x]){u[x]=true;var w="",N=a.status.get(x);if(!N||g!=d||f!=c){a.status.set(x,1);w=p("location")+": "+g;if(f&&(!N||f!=c))w+=" \n "+p("from")+": "+f}w&&a.sendMessage(G({},r,{body:w,"transient":true}))}}}).bind("beforeOnline",function(q,r){r.visitorstatus=n;r.visitor_loc=g;r.visitor_from=
f?f:""})});Q("logmsg",function(){var a=this.im;a.bind("message",function(b,c){for(var d=0;d<c.length;d++){var f=c[d];f.ticket=a.data.connection.ticket;f.to_nick=a.data.user.nick;Y({type:"get",url:na("logmsg"),cache:false,data:f})}})});Q("layout.popup",function(a){B.buddy&&(B.buddy.defaults.highlightable=true);B.room&&(B.room.defaults.highlightable=true);B.chat&&(B.chat.defaults.simple=true);a=a||{};var b=this.im,c=b.buddy,d=b.history,f=b.status,g=b.room,k=new B["layout.popup"](null,G({},a,{ui:this}));
(function(){b.bind("online",function(j,n){k.options.user=n.user;k.updateAllChat()}).bind("offline",function(){k.updateAllChat()})})();(function(){b.bind("beforeOnline",function(u,q){G(q,{buddy_ids:f.get("_cacheBuddy"),room_ids:"",show:"available"})});var j=function(u){return u&&u.id},n=function(){var u=va(c.all(true),j);f.set("_cacheBuddy",u.join(","));k.updateAllChat()};c.bind("online",n).bind("offline",n)})();(function(){g.bind("memberAdded",function(j,n,u){(j=k.chat("room",n))&&j.addMember(u.id,
u.nick,u.presence=="offline")}).bind("memberRemoved",function(j,n,u){(j=k.chat("room",n))&&j.removeMember(u.id,u.nick)})})();(function(){d.bind("chat",function(j,n,u){(j=k.chat("chat",n))&&j.history.add(u)});d.bind("grpchat",function(j,n,u){(j=k.chat("grpchat",n))&&j.history.add(u)});d.bind("clear",function(j,n,u){(j=k.chat(n,u))&&j.history.clear()})})();b.bind("message",function(j,n){for(var u=false,q=n.length,r,x=b.data.user.id,w,N,Z=0;Z<q;Z++){r=n[Z];w=r.id;type=r.type==="chat"?"buddy":"room";
(N=k.chat(type,w))&&N.status("");if(!N){(N=k.widget(type))&&N.showCount(w,"+1");k.notifyUser(type,"+1")}if(r.from!=x)u=true}if(u){E.play("msg");Ja(p("new message"),5)}});b.bind("status",function(j,n){A(n,function(u,q){var r=b.data.user.id,x=q.from;if(!(r!=q.to&&r!=q.from))(r=k.chat("buddy",x))&&r.status(q.show)})});return k});V("layout.popup",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout webim-popup ui-helper-clearfix"><div id=":left" class="webim-popup-left"></div><div id=":right" class="webim-popup-right"></div>\t<div id=":widgets" class="webim-widgets ui-widget-content ui-helper-clearfix"><div class="webim-layout-bg ui-state-default ui-toolbar"></div></div>\t</div>\t</div>',
template_tab:'<div class="webim-window-tab-wrap">\t<div id=":tab" class="webim-window-tab ui-state-default">\t<div class="webim-window-tab-inner">\t<div id=":tabTip" class="webim-window-tab-tip">\t<strong id=":tabTipC"><%=title%></strong>\t</div>\t<div id=":tabCount" class="webim-window-tab-count">\t0\t</div>\t<em id=":tabIcon" class="webim-icon webim-icon-<%=icon%>"></em>\t</div>\t</div>\t</div>'},{_init:function(){G(this,{widgets:{},widgetIds:[],tabs:{},activeTabId:null});this.win=new B.window(null,
{closeable:false,minimizable:false,isMinimize:false})},buildUI:function(){var a=this.win;a.$.window.appendChild(this.$.widgets);this.$.left.appendChild(a.element)},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var c=this.win,d=a.name;a.window=c;this.widgetIds.push(d);this.widgets[a.name]=a;C(a.element);c.$.content.appendChild(a.element);this._createTab(d,b);this.widgetIds.length==1&&this._activeTab(d)},_createTab:function(a,b){var c=this,d=R(X(c.options.template_tab,b));d.$=ca(d);
var f=d.$.tab;z(f,"click",function(g){c._activeTab(a);ja(g);F(g)});z(f,"mouseover",function(){H(this,"ui-state-hover");O(this,"ui-state-default")});z(f,"mouseout",function(){O(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&H(this,"ui-state-default")});U(f);c.$.widgets.appendChild(d);c.tabs[a]=d},_activeTab:function(a){for(var b=this.tabs,c=this.widgetIds.length-1;c>=0;c--){var d=this.widgetIds[c],f=this.widgets[d],g=b[d].$.tab;if(d==a){M(f.element);H(g,"ui-state-active");O(g,"ui-state-default");
qa(b[d].$.tabCount,0)}else if(d==this.activeTabId){C(f.element);H(g,"ui-state-default");O(g,"ui-state-active")}}this.activeTabId=a},notifyUser:function(a,b){if(a!=this.activeTabId){var c=this.tabs[a];c&&qa(c.$.tabCount,b)}},focusChat:function(){},chat:function(a,b){if(!a||this.__chat&&this.__chat.__id==ea(a,b))return this.__chat;return null},updateChat:function(){var a=this.chat();a&&a.update()},updateAllChat:function(){this.updateChat()},addChat:function(a,b,c,d,f){a=P(a);var g=this;g.__chat&&oa(g.__chat.window.element);
var k=g.widget(a=="room"?"buddy":"room");k&&k.active(null);(k=g.widget(a))&&k.active(b);var j=(new B.window(null,G({minimizable:false},d))).bind("close",function(){g.__chat=null;k&&k.active()});c=g.__chat=g.options.ui.addApp("chat",G({},g.options.ui.options[a+"ChatOptions"],{id:b,type:a,nick:f,winOptions:d},c));c.__id=ea(a,b);c.setWindow(j);g.$.right.appendChild(j.element)}})})(window,document);
