(function(m,u,K){function G(a){return ba.call(a)==="[object Function]"}function P(a){return ba.call(a)==="[object Array]"}function S(a){return a&&ba.call(a)==="[object Object]"}function T(a){return(a||"").replace(/^\s+|\s+$/g,"")}function U(a,b){var c=false;if(S(b)){a=a||{};for(var d in b){var f=b[d];if(a[d]!=f){c=c||{};c[d]=f}}}return c}function X(a){var b=[];if(a!=null){var c=a.length;if(c==null||typeof a==="string"||G(a)||a.setInterval)b[0]=a;else for(;c;)b[--c]=a[c]}return b}function h(){var a=
arguments[0]||{},b=1,c=arguments.length,d=false,f;if(typeof a==="boolean"){d=a;a=arguments[1]||{};b=2}if(typeof a!=="object"&&!G(a))a={};for(;b<c;b++)if((f=arguments[b])!=null)for(var g in f){var j=a[g],p=f[g];if(a!==p)if(d&&p&&typeof p==="object"&&!p.nodeType)a[g]=h(d,j||(p.length!=null?[]:{}),p);else if(p!==K)a[g]=p}return a}function k(a,b,c){var d,f=0,g=a.length,j=g===K||G(a);if(c)if(j)for(d in a){if(b.apply(a[d],c)===false)break}else for(;f<g;){if(b.apply(a[f++],c)===false)break}else if(j)for(d in a){if(b.call(a[d],
d,a[d])===false)break}else for(c=a[0];f<g&&b.call(c,f,c)!==false;c=a[++f]);return a}function l(a,b,c){for(var d=[],f=0,g=a.length;f<g;f++)!c!==!b(a[f],f)&&d.push(a[f]);return d}function A(a,b){for(var c=[],d,f=0,g=a.length;f<g;f++){d=b(a[f],f);if(d!=null)c[c.length]=d}return c.concat.apply([],c)}function D(a){this.type=a;this.timeStamp=(new Date).getTime()}function F(a){this.URL=a;this._setting();this._connect()}function v(a,b){var c=this;b=b||{};var d=c.ws=new WebSocket(a);d.onopen=function(){c.trigger("open",
"success");d.send("subscribe "+b.domain+" "+b.ticket)};d.onclose=function(f){c.trigger("close",[f.data])};d.onmessage=function(f){f=f.data;try{f=f?m.JSON&&m.JSON.parse?m.JSON.parse(f):(new Function("return "+f))():f}catch(g){}c.trigger("message",[f])};d.onerror=function(){c.trigger("error",[])}}function H(a,b,c){if(typeof b!="undefined"){c=c||{};if(b===null){b="";c.expires=-1}var d="";if(c.expires&&(typeof c.expires=="number"||c.expires.toUTCString)){if(typeof c.expires=="number"){d=new Date;d.setTime(d.getTime()+
c.expires*24*60*60*1E3)}else d=c.expires;d="; expires="+d.toUTCString()}var f=c.path?"; path="+c.path:"",g=c.domain?"; domain="+c.domain:"";c=c.secure?"; secure":"";u.cookie=[a,"=",encodeURIComponent(b),d,f,g,c].join("")}else{b=null;if(u.cookie&&u.cookie!=""){c=u.cookie.split(";");for(d=0;d<c.length;d++){f=T(c[d]);if(f.substring(0,a.length+1)==a+"="){b=decodeURIComponent(f.substring(a.length+1));break}}}return b}}function q(a,b){this.options=h({},q.defaults,b);this._init(a,b)}function ea(a){return a&&
a.split?a.split(","):P(a)?a:parseInt(a)?[parseInt(a)]:[]}function Q(a,b,c){function d(f,g){this.data=f;this.options=h({},d.defaults,g);G(this._init)&&this._init()}d.defaults=b;D.on(d);h(d.prototype,c);q[a]=d}function w(a,b){if(typeof a=="string"){a[a]=b;if(b===K)return w[a]}h(w,a)}var ba=Object.prototype.toString;D.on=function(){for(var a,b=D.on.prototype,c=0,d=arguments.length;c<d;c++){a=arguments[c].prototype;a.bind=a.addEventListener=b.addEventListener;a.unbind=a.removeEventListener=b.removeEventListener;
a.trigger=a.dispatchEvent=b.dispatchEvent}};D.on.prototype={addEventListener:function(a,b){var c=this.__listeners=this.__listeners||{};c[a]=c[a]||[];c[a].push(b);return this},dispatchEvent:function(a,b){var c=this.__listeners=this.__listeners||{};a=a.type?a:new D(a);c=c[a.type];if(Object.prototype.toString.call(b)==="[object Array]")b.unshift(a);else b=[a,b];if(c)for(var d=0,f=c.length;d<f;d++)c[d].apply(this,b);return this},removeEventListener:function(a,b){var c=this.__listeners=this.__listeners||
{};if(c[a])if(b){c=c[a];for(var d=c.length;d--;)c[d]===b&&c.splice(d,1)}else delete c[a];return this}};var x=function(){function a(i){var e={};for(var r in a.settings)e[r]=a.settings[r];if(i)for(r in i)e[r]=i[r];if(e.dataType==="jsonp")e.type="GET";var t,B,L,O=e.type.toUpperCase(),fa=f.test(O),M,z,ga=m,C;e.url=e.url.replace(ca,"");e.context=i&&i.context!=null?i.context:e;if(e.data&&e.processData&&typeof e.data!=="string")e.data=b(e.data,e.traditional);var N=y.exec(e.url);r=m.location;N=N&&(N[1]&&
N[1]!==r.protocol||N[2]!==r.host);/https?:/i.test(r.protocol)||(N=false);N=e.forceRemote?true:N;if(e.dataType==="jsonp"&&!N)e.dataType="json";if(e.dataType==="jsonp"){if(O==="GET")j.test(e.url)||(e.url+=(p.test(e.url)?"&":"?")+(e.jsonp||"callback")+"=?");else if(!e.data||!j.test(e.data))e.data=(e.data?e.data+"&":"")+(e.jsonp||"callback")+"=?";e.dataType="json"}if(e.dataType==="json"&&(e.data&&j.test(e.data)||j.test(e.url))){t=e.jsonpCallback||"jsonp"+c++;if(e.data)e.data=(e.data+"").replace(j,"="+
t+"$1");e.url=e.url.replace(j,"="+t+"$1");e.dataType="script";var ha=m[t],Y=false;m[t]=function(I){if(!Y){Y=true;if(Object.prototype.toString.call(ha)==="[object Function]")ha(I);else{m[t]=K;try{delete m[t]}catch(Z){}}L=I;s.handleSuccess(e,n,B,L);s.handleComplete(e,n,B,L);M&&M.removeChild(C);z&&z.parentNode&&z.parentNode.removeChild(z)}}}if(e.dataType==="script"&&e.cache===null)e.cache=false;if(e.cache===false&&O==="GET"){var ia=(new Date).getTime(),ja=e.url.replace(o,"$1_="+ia);e.url=ja+(ja===e.url?
(p.test(e.url)?"&":"?")+"_="+ia:"")}if(e.data&&O==="GET")e.url+=(p.test(e.url)?"&":"?")+e.data;e.global&&s.active++;if(e.dataType==="script"&&O==="GET"&&N){i=false;if(t&&e.async&&!d)if(m._fragmentProxy)M=z=u.createDocumentFragment();else{i=true;if(e.url.slice(0,1)=="/")e.url=r.protocol+"//"+r.host+(r.port?":"+r.port:"")+e.url;else if(!/^https?:\/\//i.test(e.url)){r=r.href;O=/([^?#]+)\//.exec(r);e.url=(O?O[1]:r)+"/"+e.url}e.url=e.url.replace("="+t,"=parent."+t);z=u.createElement("iframe");z.style.position=
"absolute";z.style.left="-100px";z.style.top="-100px";z.style.height="1px";z.style.width="1px";z.style.visibility="hidden";u.body.insertBefore(z,u.body.firstChild);ga=z.contentWindow}var ka=function(){var I;try{I=ga.document}catch(Z){I=m.document}M=M||I.getElementsByTagName("head")[0]||I.documentElement;C=I.createElement("script");if(e.scriptCharset)C.charset=e.scriptCharset;C.src=e.url;if(d)C.async=e.async;if(t)C.onload=C.onerror=C.onreadystatechange=function(){if(!Y&&(!this.readyState||this.readyState===
"loaded"||this.readyState==="complete")){Y=true;s.handleError(e,n,"error","load error");M&&C.parentNode&&M.removeChild(C);z&&z.parentNode&&z.parentNode.removeChild(z)}};else{var $=false;C.onload=C.onreadystatechange=function(){if(!$&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){$=true;s.handleSuccess(e,n,B,L);s.handleComplete(e,n,B,L);C.onload=C.onreadystatechange=null;M&&C.parentNode&&M.removeChild(C)}}}M.insertBefore(C,M.firstChild)};i?setTimeout(function(){ka()},
0):ka();return K}var V=false,n=e.xhr();if(n){e.username?n.open(O,e.url,e.async,e.username,e.password):n.open(O,e.url,e.async);try{if(e.data!=null&&!fa||i&&i.contentType)n.setRequestHeader("Content-Type",e.contentType);if(e.ifModified){s.lastModified[e.url]&&n.setRequestHeader("If-Modified-Since",s.lastModified[e.url]);s.etag[e.url]&&n.setRequestHeader("If-None-Match",s.etag[e.url])}N||n.setRequestHeader("X-Requested-With","XMLHttpRequest");n.setRequestHeader("Accept",e.dataType&&e.accepts[e.dataType]?
e.accepts[e.dataType]+", */*; q=0.01":e.accepts._default)}catch(na){}if(e.beforeSend&&e.beforeSend.call(e.context,n,e)===false){e.global&&s.active--;n.abort();return false}e.global&&s.triggerGlobal(e,"ajaxSend",[n,e]);var da=n.onreadystatechange=function(I){if(!n||n.readyState===0||I==="abort"){V||s.handleComplete(e,n,B,L);V=true;if(n)n.onreadystatechange=s.noop}else if(!V&&n&&(n.readyState===4||I==="timeout")){V=true;n.onreadystatechange=s.noop;B=I==="timeout"?"timeout":!s.httpSuccess(n)?"error":
e.ifModified&&s.httpNotModified(n,e.url)?"notmodified":"success";var Z;if(B==="success")try{L=s.httpData(n,e.dataType,e)}catch($){B="parsererror";Z=$}if(B==="success"||B==="notmodified")t||s.handleSuccess(e,n,B,L);else s.handleError(e,n,B,Z);t||s.handleComplete(e,n,B,L);I==="timeout"&&n.abort();if(e.async)n=null}};try{var la=n.abort;n.abort=function(){n&&la.call&&la.call(n);da("abort")}}catch(oa){}e.async&&e.timeout>0&&setTimeout(function(){n&&!V&&da("timeout")},e.timeout);try{n.send(fa||e.data==
null?null:e.data)}catch(ma){s.handleError(e,n,null,ma);s.handleComplete(e,n,B,L)}e.async||da();return n}}function b(i){var e=[];if(typeof i=="object"){for(var r in i)e[e.length]=encodeURIComponent(r)+"="+encodeURIComponent(i[r]);return e.join("&").replace(J,"+")}return i}var c=(new Date).getTime(),d=typeof u.createElement("script").async==="boolean",f=/^(?:GET|HEAD|DELETE)$/,g=/\S/,j=/\=\?(&|$)/,p=/\?/,o=/([?&])_=[^&]*/,y=/^(\w+:)?\/\/([^\/?#]+)/,J=/%20/g,ca=/#.*$/;m._fragmentProxy=false;var W=u.createDocumentFragment(),
E=u.createElement("script");try{E.appendChild(u.createTextNode("window._fragmentProxy = true"))}catch(R){E.text="window._fragmentProxy = true"}W.appendChild(E);W=E=null;a.param=b;var s={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(i,e,r,t){i.error&&i.error.call(i.context,e,r,t);i.global&&s.triggerGlobal(i,"ajaxError",[e,i,t])},handleSuccess:function(i,e,r,t){i.success&&i.success.call(i.context,t,r,e);i.global&&s.triggerGlobal(i,"ajaxSuccess",[e,i])},handleComplete:function(i,
e,r){i.complete&&i.complete.call(i.context,e,r);i.global&&s.triggerGlobal(i,"ajaxComplete",[e,i]);i.global&&s.active--},triggerGlobal:function(){},httpSuccess:function(i){try{return!i.status&&location.protocol==="file:"||i.status>=200&&i.status<300||i.status===304||i.status===1223}catch(e){}return false},httpNotModified:function(i,e){var r=i.getResponseHeader("Last-Modified"),t=i.getResponseHeader("Etag");if(r)s.lastModified[e]=r;if(t)s.etag[e]=t;return i.status===304},httpData:function(i,e,r){var t=
i.getResponseHeader("content-type")||"",B=e==="xml"||!e&&t.indexOf("xml")>=0;i=B?i.responseXML:i.responseText;B&&i.documentElement.nodeName==="parsererror"&&s.error("parsererror");if(r&&r.dataFilter)i=r.dataFilter(i,e);if(typeof i==="string")if(e==="json"||!e&&t.indexOf("json")>=0)i=i?m.JSON&&m.JSON.parse?m.JSON.parse(i):(new Function("return "+i))():i;else if(e==="script"||!e&&t.indexOf("javascript")>=0)if(i&&g.test(i)){e=u.getElementsByTagName("head")[0]||u.documentElement;r=u.createElement("script");
r.type="text/javascript";try{r.appendChild(u.createTextNode(i))}catch(L){r.text=i}e.insertBefore(r,e.firstChild);e.removeChild(r)}return i}};a.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new m.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};a.setup=
function(i){if(i)for(var e in i)a.settings[e]=i[e]};if(m.ActiveXObject)a.settings.xhr=function(){if(m.location.protocol!=="file:")try{return new m.XMLHttpRequest}catch(i){}try{return new m.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}};return a}(),aa=m.JSON?m.JSON:function(){function a(d){return c[d]||"\\u00"+Math.floor(d.charCodeAt()/16).toString(16)+(d.charCodeAt()%16).toString(16)}function b(d){switch(Object.prototype.toString.call(d)){case "[object String]":return'"'+d.replace(/[\x00-\x1f\\"]/g,
a)+'"';case "[object Array]":for(var f=[],g=d.length,j=0;j<g;j++)f.push(b(d[j]));return"["+f.join(",")+"]";case "[object Object]":f=[];for(g in d)(j=b(d[g]))&&f.push(b(g)+":"+j);return"{"+f+"}";case "[object Number]":case "[object Boolean]":return String(d);case false:return"null"}return null}var c={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:b,parse:function(d){d=d.toString();if(!d||!d.length)return null;return(new Function("return "+d))()}}}();
F.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=F.CLOSED;this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var a=this;if(a._connecting)return a;a.readyState=F.CONNECTING;a._connecting=true;a._onPolling||m.setTimeout(function(){a._startPolling()},300);return a},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=F.OPEN;this.trigger("open",
"success")},_onClose:function(a){var b=this;b._setting();setTimeout(function(){b.trigger("close",[a])},1E3)},_onData:function(a){this.trigger("message",[a])},_onError:function(a){var b=this;b._setting();setTimeout(function(){b.trigger("error",[a])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;x({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(a){var b=this;b._onPolling=
false;if(b._connecting)if(a){b._pollingTimes==1&&b._onConnect();b._onData(a);b._failTimes=0;b._pollTimer=m.setTimeout(function(){b._startPolling()},200)}else return b._onError("error data")},_onPollError:function(a){var b=this;b._onPolling=false;if(b._connecting){b._failTimes++;if(b._pollingTimes==1)b._onError("can not connect.");else if(b._failTimes>1)b._onClose(a);else b._pollTimer=m.setTimeout(function(){b._startPolling()},200)}}};F.CONNECTING=0;F.OPEN=1;F.CLOSED=2;D.on(F);v.prototype={readyState:0,
send:function(){},close:function(){this.ws.close()}};v.enable=!!m.WebSocket;v.CONNECTING=0;v.OPEN=1;v.CLOSED=2;D.on(v);D.on(q);q.csrf_token="";q.OFFLINE=0;q.BEFOREONLINE=1;q.ONLINE=2;h(q.prototype,{state:q.OFFLINE,_init:function(){var a=this.options;this.data={user:{presence:"offline",show:"unavailable"}};this.models={};x.settings.dataType=a.jsonp?"jsonp":"json";this.status=new q.status(null,a);this.setting=new q.setting;this.models.presence=new q.presence;this.buddy=new q.buddy;this.room=new q.room(null,
this.data);this.history=new q.history(null,this.data);this._initEvents()},_createConnect:function(){var a=this,b=a.data.connection;a.connection=a.options.connectionType!="jsonpd"&&b.websocket&&v.enable?new v(b.websocket,b):new F(b.server+(/\?/.test(b)?"&":"?")+x.param({ticket:b.ticket,domain:b.domain}));a.connection.bind("connect",function(){}).bind("message",function(c,d){a.handle(d)}).bind("error",function(){a._stop("connect","Connect Error")}).bind("close",function(){a._stop("connect","Disconnect")})},
setUser:function(a){h(this.data.user,a)},_ready:function(a){this.state=q.BEFOREONLINE;this.trigger("beforeOnline",[a])},_go:function(){var a=this.data,b=this.history,c=this.buddy,d=this.room,f=this.models.presence;this.state=q.ONLINE;b.options.userInfo=a.user;k(a.buddies,function(g,j){b.init("chat",j.id,j.history)});c.set(a.buddies);a.presences?f.set(a.presences):f.set(A(a.buddies,function(g){var j={};j[g.id]=g.show;return j}));k(a.rooms,function(g,j){b.init("grpchat",j.id,j.history)});d.set(a.rooms);
d.options.ticket=a.connection.ticket;this.trigger("online",[a]);this._createConnect();c=[];if(a.new_messages)c=c.concat(a.new_messages);if(a.offline_messages)c=c.concat(a.offline_messages);if(c&&c.length){k(c,function(g,j){j["new"]=true});this.trigger("message",[c])}},_stop:function(a,b){if(this.state!==q.OFFLINE){this.state=q.OFFLINE;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.models.presence.clear();this.room.clear();this.history.clean();this.trigger("offline",
[a,b])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function a(o){var y={id:o.from,presence:o.type};if(o.show)y.show=o.show;if(o.nick)y.nick=o.nick;if(o.status)y.status=o.status;return y}function b(o){return o.type=="online"||o.type=="offline"||o.type=="show"}function c(o){return o.type=="grponline"||o.type=="grpoffline"||o.type=="invite"||o.type=="join"||o.type=="leave"}var d=this,f=d.history,g=d.buddy,j=d.models.presence,p=d.room;d.bind("message",function(o,y){for(var J=
[],ca=y.length,W=d.data.user.id,E,R,s,i=0;i<ca;i++){E=y[i];s=E.type;R=s=="chat"?E.to==W?E.from:E.to:E.to;E.id=R;if(s=="chat"&&!E["new"]){R={id:R,presence:"online"};if(E.nick&&E.to==W)R.nick=E.nick;J.push(R)}}if(J.length){g.presence(J);g.complete()}f.set(y)});d.bind("presence",function(o,y){var J=l(y,b);g.presence(A(J,a));j.update(J);y=l(y,c);for(J=y.length-1;J>=0;J--)p.onPresence(y[J])})},handle:function(a){if(a.messages&&a.messages.length){for(var b=a.messages,c=[],d=[],f=0;f<b.length;f++){var g=
b[f];if(g.body&&g.body.indexOf("webim-event:")==0){g.event=g.body.replace("webim-event:","").split("|,|");d.push(g)}else c.push(g)}c.length&&this.trigger("message",[c]);d.length&&this.trigger("event",[d])}a.presences&&a.presences.length&&this.trigger("presence",[a.presences]);a.statuses&&a.statuses.length&&this.trigger("status",[a.statuses])},sendMessage:function(a,b){a.ticket=this.data.connection.ticket;this.trigger("sendMessage",[a]);x({type:"post",cache:false,url:w("message"),data:h({csrf_token:q.csrf_token},
a),success:b,error:b})},sendStatus:function(a,b){a.ticket=this.data.connection.ticket;this.trigger("sendStatus",[a]);x({type:"post",cache:false,url:w("status"),data:h({csrf_token:q.csrf_token},a),success:b,error:b})},sendPresence:function(a,b){a.ticket=this.data.connection.ticket;this.data.user.show=a.show;this.status.set("s",a.show);this.trigger("sendPresence",[a]);x({type:"post",cache:false,url:w("presence"),data:h({csrf_token:q.csrf_token},a),success:b,error:b})},online:function(a){var b=this,
c=b.status;if(b.state===q.OFFLINE){var d=[],f=[],g=c.get("tabs"),j=c.get("tabIds");j&&j.length&&g&&k(g,function(p){p[0]=="b"&&d.push(p.slice(2));p[0]=="r"&&f.push(p.slice(2))});a=h({buddy_ids:d.join(","),room_ids:f.join(","),csrf_token:q.csrf_token,show:c.get("s")||"available"},a);b._ready(a);c.set("o",false);c.set("s",a.show);x({type:"post",cache:false,url:w("online"),data:a,success:function(p){if(p)if(p.success){p.user=h(b.data.user,p.user,{presence:"online"});b.data=p;b._go()}else b._stop("online",
p.error_msg);else b._stop("online","Not Found")},error:function(){b._stop("online","Not Found")}})}},offline:function(){var a=this.data;if(this.state!==q.OFFLINE){this.status.set("o",true);this.connection.close();this._stop("offline","offline");x({type:"post",cache:false,url:w("offline"),data:{status:"offline",csrf_token:q.csrf_token,ticket:a.connection.ticket}})}},_deactivate:function(){var a=this.data;!a||!a.connection||!a.connection.ticket||x({type:"get",cache:false,url:w("deactivate"),data:{ticket:a.connection.ticket,
csrf_token:q.csrf_token}})}});m.webim=q;h(q,{version:"5.5",defaults:{},log:function(){var a=new Date;["[",a.getHours(),":",a.getMinutes(),":",a.getSeconds(),"-",a.getMilliseconds(),"]"].join("");if(m&&m.console)m.console.log.apply(null,arguments);else m&&m.runtime&&m.air&&m.air.Introspector&&m.air.Introspector.Console.log.apply(null,arguments)},idsArray:ea,now:function(){return(new Date).getTime()},isFunction:G,isArray:P,isObject:S,trim:T,makeArray:X,extend:h,each:k,inArray:function(a,b){for(var c=
0,d=b.length;c<d;c++)if(b[c]===a)return c;return-1},grep:l,map:A,JSON:aa,ajax:x,comet:F,socket:v,model:Q,route:w,ClassEvent:D,isMobile:function(){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(navigator.userAgent||navigator.vendor||
m.opera)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test((navigator.userAgent||
navigator.vendor||m.opera).substr(0,4))}});Q("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){this.data=h({},this.options.data,this.data)},get:function(a){return this.data[a]},set:function(a,b){var c=this,d=a;if(a){if(typeof a=="string"){d={};d[a]=b}var f=c.data,g=U(f,d);if(g){k(g,function(j,p){c.trigger("update",[j,p])});d=h({},f,d);c.data=d;x({type:"post",url:w("setting"),cache:false,data:{data:aa.stringify(d),csrf_token:q.csrf_token}})}}}});
Q("status",{key:"_webim",storage:"local",domain:u.domain},{_init:function(){var a=this.data,b=this.options.key,c=this.options.storage=="local"&&m.localStorage;if(c)try{c.setItem("__store_webim__","__store_webim__");if(c.getItem("__store_webim__")=="__store_webim__")this.store=c;c.removeItem("__store_webim__")}catch(d){this.store=K}if(a)this._save(a);else this.data=(a=this.store?this.store.getItem(b):H(b))?aa.parse(a):{}},set:function(a,b){var c=a;if(typeof a=="string"){c={};c[a]=b}var d=this.data;
U(d,c)&&this._save(h({},d,c))},get:function(a){return this.data[a]},clear:function(){this._save({})},_save:function(a){var b=this.options.key,c=this.options.domain;this.data=a;a=aa.stringify(a);this.store?this.store.setItem(b,a):H(b,a,{path:"/",domain:c})}});Q("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},remove:function(a){var b=this.get(a);if(b){x({type:"post",url:w("remove_buddy"),cache:false,data:{id:a,csrf_token:q.csrf_token},success:function(){}});
this.trigger("unsubscribe",[[b]]);delete this.dataHash[a]}},clear:function(){this.data=[];this.dataHash={}},count:function(a){var b=this.dataHash,c=0,d;for(var f in b)if(S(a)){d=true;for(var g in a)if(a[g]!=b[f][g])d=false;d&&c++}else c++;return c},get:function(a){return this.dataHash[a]},all:function(a){return a?l(this.data,function(b){return b.show!="invisible"&&b.presence=="online"}):this.data},complete:function(){var a=this.dataHash,b=[],c;for(var d in a){c=a[d];if(c.incomplete){c.incomplete=
false;b.push(d)}}this.load(b)},update:function(a){this.load(a)},presence:function(a){var b=this.dataHash;a=P(a)?a:[a];for(var c in a){var d=a[c];d.presence=d.presence=="offline"?"offline":"online";d.incomplete=!b[d.id];if(!d.group&&d.id)d.group=d.id.indexOf("vid:")==0?"visitor":d.group}this.set(a)},load:function(a){a=ea(a);a.length&&x({type:"get",url:w("buddies"),cache:false,data:{ids:a.join(","),csrf_token:q.csrf_token},context:this,success:this.set})},search:function(a,b){var c=this;x({type:"post",
url:w("search"),cache:false,data:{nick:a,csrf_token:q.csrf_token},context:c,success:function(d){c.set(d);setTimeout(b,500)}})},set:function(a){var b=this.data,c=this.dataHash,d={};a=a||[];for(var f=a.length,g,j,p,o=0;o<f;o++){g=a[o];if(p=g.id){if(!c[p]){g.presence=g.presence||"online";g.show=g.show?g.show:g.presence=="offline"?"unavailable":"available";c[p]={};b.push(c[p])}g.incomplete=!!g.incomplete;if(j=U(c[p],g)){g=j.presence||"update";d[g]=d[g]||[];h(c[p],j);d[g].push(c[p])}}}for(var y in d)this.trigger(y,
[d[y]]);this.options.active&&this.complete()}});Q("presence",{},{_init:function(){this.data=this.data||{};this.set(this.data)},get:function(a){return this.data[a]},set:function(a){var b={};for(var c in a){var d=a[c],f="online";if(d=="unavailable"||d=="invisible")f="offline";b[f]=b[f]||[];b[f].push({id:c,show:d})}for(var g in b)this.trigger(g,[b[g]])},update:function(a){for(var b={},c=0;c<a.length;c++){var d=a[c];b[d.from]=d.show}this.set(b)},clear:function(){this.data=[]}});(function(){Q("room",{},
{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(a){return this.dataHash[a]},all:function(a){return a?l(this.data,function(b){return b.temporary}):this.data},invite:function(a,b,c,d){var f=this,g=f.options;x({type:"post",cache:false,url:w("invite"),data:{ticket:g.ticket,id:a,nick:b||"",members:c.join(","),csrf_token:q.csrf_token},success:function(j){f.set([j]);f.loadMember(a);d&&d(j)}})},join:function(a,b,c){var d=this,f=d.options;x({type:"post",cache:false,url:w("join"),data:{ticket:f.ticket,
id:a,nick:b||"",csrf_token:q.csrf_token},success:function(g){d.set([g]);d.loadMember(a);c&&c(g)}})},leave:function(a){var b=this,c=b.options,d=b.dataHash[a],f=c.user;d&&x({type:"post",cache:false,url:w("leave"),data:{ticket:c.ticket,id:a,nick:f.nick,temporary:d.temporary,csrf_token:q.csrf_token},success:function(){delete b.dataHash[a];b.trigger("leaved",[a])}})},block:function(a){var b=this,c=b.options,d=b.dataHash[a];if(d&&!d.blocked){d.blocked=true;var f=[];k(b.dataHash,function(g,j){!j.temporary&&
j.blocked&&f.push(j.id)});x({type:"post",cache:false,url:w("block"),data:{ticket:c.ticket,id:a,csrf_token:q.csrf_token},success:function(){b.trigger("blocked",[a,f])}})}},unblock:function(a){var b=this,c=b.options,d=b.dataHash[a];if(d&&d.blocked){d.blocked=false;var f=[];k(b.dataHash,function(g,j){!j.temporary&&j.blocked&&f.push(j.id)});x({type:"post",cache:false,url:w("unblock"),data:{ticket:c.ticket,id:a,csrf_token:q.csrf_token},success:function(){b.trigger("unblocked",[a,f])}})}},set:function(a){var b=
this,c=b.data,d=b.dataHash;k(a,function(f,g){var j=g.id;if(j){g.members=g.members||[];g.all_count=g.members.length;g.count=0;k(g.members,function(p,o){if(o.presence=="online")g.count+=1});if(d[j])h(d[j],g);else{d[j]=g;c.push(g)}b.trigger("updated",d[j])}})},loadMember:function(a){var b=this,c=b.options;x({type:"get",cache:false,url:w("members"),data:{ticket:c.ticket,id:a,csrf_token:q.csrf_token},success:function(d){b.updateMember(a,d)}})},updateMember:function(a,b){var c=this.dataHash[a];if(c){c.memberLoaded=
true;c.members=b;this.set([c])}},onPresence:function(a){var b=a.type;if(a.to&&this.dataHash[a.to]){var c=a.to,d=this.dataHash[c];d&&d.memberLoaded&&this.loadMember(c);if(b=="join")this.trigger("memberJoined",[c,a]);else if(b=="leave")this.trigger("memberLeaved",[c,a]);else if(b=="grponline")this.trigger("memberOnline",[c,a]);else b=="grpoffline"&&this.trigger("memberOffline",[c,a])}},clear:function(){this.data=[];this.dataHash={}}})})();Q("history",{},{_init:function(){this.data=this.data||{};this.data.chat=
this.data.chat||{};this.data.grpchat=this.data.grpchat||{}},clean:function(){this.data.chat={};this.data.grpchat={}},get:function(a,b){return this.data[a][b]},set:function(a){var b=this.data,c={chat:{},grpchat:{}};a=X(a);var d=a.length,f,g,j=this.options.userInfo.id;if(d){for(var p=0;p<d;p++){f=a[p];o=f.type;if((g=o=="chat"?f.to==j?f.from:f.to:f.to)&&o){c[o][g]=c[o][g]||[];c[o][g].push(f)}}for(var o in c)for(g in c[o]){f=c[o][g];if(b[o][g]){b[o][g]=[].concat(b[o][g]).concat(f);this._triggerMsg(o,
g,f)}else this.load(o,g)}}},_triggerMsg:function(a,b,c){this.trigger(a,[b,c])},clear:function(a,b){this.data[a][b]=[];this.trigger("clear",[a,b]);x({url:w("clear"),type:"post",cache:false,data:{type:a,id:b,csrf_token:q.csrf_token}})},download:function(a,b){var c=w("download"),d=u.createElement("iframe"),f=new Date,g=[];f={id:b,type:a,time:(new Date).getTime(),date:f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()};for(var j in f)g[g.length]=encodeURIComponent(j)+"="+encodeURIComponent(f[j]);c+=
(/\?/.test(c)?"&":"?")+g.join("&");d.setAttribute("src",c);d.style.display="none";u.body.appendChild(d)},init:function(a,b,c){if(P(c)){this.data[a][b]=c;this._triggerMsg(a,b,c)}},load:function(a,b){var c=this;c.data[a][b]=[];x({url:w("history"),cache:false,type:"get",data:{type:a,id:b,csrf_token:q.csrf_token},success:function(d){c.init(a,b,d)}})}})})(window,document);
(function(m,u){function K(h,k,l){if(h.addEventListener)h.addEventListener(k,l,false);else{h["e"+k+l]=l;h[k+l]=function(){return h["e"+k+l](m.event)};h.attachEvent("on"+k,h[k+l])}}function G(h){var k=new Date;k.setTime(h?parseFloat(h)+G.timeSkew:(new Date).getTime());this.date=k}function P(h,k){var l=this;l.im=h;l.presences={};l.touid=k.touid||l.el("to").value;l.tonick=k.tonick||l.el("user").innerHTML;h.bind("beforeOnline",function(){}).bind("online",function(v,H){l.ready(H);H.presences[l.touid]?l.notice(l.tonick+
"\u5728\u7ebf\uff0c\u73b0\u5728\u53ef\u4ee5\u5f00\u59cb\u804a\u5929"):l.notice(l.tonick+"\u5df2\u79bb\u7ebf, \u60a8\u53d1\u9001\u7684\u6d88\u606f\u5c06\u5728'"+l.tonick+"'\u4e0a\u7ebf\u65f6\u6536\u5230")}).bind("offline",function(){}).bind("message",function(v,H){l.recevied(H)}).bind("event",function(){});var A=l.el("inputbox"),D=l.el("sendbtn"),F=function(){var v=A.value;if(S(v).length){l.send(v);A.value=""}};D&&K(D,"click",function(){F()});K(A,"keypress",function(v){v.keyCode==13&&F()});h.buddy.bind("online",
function(v,H){if(H[0]&&H[0].id==l.touid){l.presences[l.touid]="online";l.notice(l.tonick+"\u5728\u7ebf\uff0c\u73b0\u5728\u53ef\u4ee5\u5f00\u59cb\u804a\u5929")}}).bind("offline",function(v,H){if(H[0]&&H[0].id==l.touid){delete l.presences[l.touid];l.notice(l.tonick+"\u5df2\u79bb\u7ebf, \u60a8\u53d1\u9001\u7684\u6d88\u606f\u5c06\u5728'"+l.tonick+"'\u4e0a\u7ebf\u65f6\u6536\u5230")}})}var S=webim.trim,T=webim.extend,U=webim.ClassEvent;G.timeSkew=0;G.init=function(h){G.timeSkew=(new Date).getTime()-parseFloat(h)};
T(G.prototype,{getTime:function(){var h=this.date,k=h.getHours();h=h.getMinutes();if(h<10)h="0"+h;return k+":"+h+""},getDay:function(h){var k=this.date;if(h){h=new Date;h.setHours(0);h.setMinutes(0);h.setSeconds(0);h.setMilliseconds(0);h=h.getTime()-k.getTime();if(h<=0)return i18n("dt:today");else if(h<864E5)return i18n("dt:yesterday")}return i18n("dt:monthdate",{month:i18n(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november",
"dt:december"][k.getMonth()]),date:k.getDate()})}});var X=function(){var h=false;K(m,"focus",function(){h=false});K(m,"blur",function(){h=true});var k=u.title,l=0,A=false;return function(D,F){if(h){if(v){clearInterval(v);l=0;A=false}var v=setInterval(function(){l++;A=!A;if(l==F||!h){clearInterval(v);l=0;A=false}u.title=A?"["+D+"]"+k:k},1500)}}}();U.on(P);T(P.prototype,{ready:function(h){this.user=h.user;this.buddies=h.buddies;this.presences=h.presences;G.init(h.server_time)},el:function(h){return u.getElementById(h)},
createEl:function(h){var k=u.createElement("div");k.innerHTML=h;return k=k.firstChild},notice:function(h){var k=this.el("notice");k.style.display="block";k.innerHTML=h},send:function(h){var k=this;if(h){var l={type:"chat",to:k.touid,from:k.user.id,nick:k.user.nick,to_nick:k.tonick,offline:k.presences[k.touid]?"false":"true",body:h,timestamp:(new Date).getTime()-G.timeSkew};k.im.sendMessage(l,function(A){A&&k.append(l)})}},recevied:function(h){for(var k=0;k<h.length;k++)this.append(h[k]);X("\u60a8\u6709\u65b0\u6d88\u606f",
5)},append:function(h){var k=this.el,l=[],A=(new G(h.timestamp)).getTime(),D=h.from==this.user.id?"speech-bubble-me":"speech-bubble";l.push('<div class="message'+(h.from==this.user.id?" me":"")+'">');this.lastfrom&&this.lastfrom==h.from||l.push("<h4>"+h.nick+' <span class="gray">'+A+"</span></h4>");l.push('<p class="'+D+'">'+h.body+"</p>");l.push("</div>");k("histories").appendChild(this.createEl(l.join("")));k=k("content");k.scrollTop=k.scrollHeight;this.lastfrom=h.from}});webim.chatbox=P})(window,
document);
